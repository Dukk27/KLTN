@model KLTN.ViewModels.HousePostViewModel

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="~/css/iziToast.css">
<link rel="stylesheet" href="~/css/edit.css" asp-append-version="true" />

<h2 style="color: rgb(35, 164, 207); text-align: center;">Ch·ªânh s·ª≠a th√¥ng tin nh√† tr·ªç</h2>

<form asp-action="EditHouse" method="post" enctype="multipart/form-data">
    <input type="hidden" asp-for="House.IdHouse" />

    <div class="form-group">
        <label asp-for="House.NameHouse">T√™n nh√† tr·ªç</label>
        <input asp-for="House.NameHouse" class="form-control" />
        <span asp-validation-for="House.NameHouse" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label>Lo·∫°i nh√† tr·ªç</label>
        <select asp-for="SelectedHouseType" asp-items="Model.HouseTypes" class="form-control">
            <option value="">-- Ch·ªçn lo·∫°i nh√† tr·ªç --</option>
        </select>
        <span asp-validation-for="SelectedHouseType" class="text-danger"></span>
    </div>

    <div class="form-group position-relative">
        <label asp-for="HouseDetail.Address">ƒê·ªãa ch·ªâ</label>
        <input asp-for="HouseDetail.Address" id="houseAddress" class="form-control" autocomplete="off" />
        <ul id="addressSuggestions" class="list-group position-absolute w-100"></ul>
        <span asp-validation-for="HouseDetail.Address" class="text-danger"></span>
    </div>

    <label for="ContactName2">Ng∆∞·ªùi li√™n h·ªá ph·ª•:</label>
    <input type="text" id="ContactName2" asp-for="ContactName2" class="form-control" />

    <label for="ContactPhone2">S·ªë ƒëi·ªán tho·∫°i ph·ª•:</label>
    <input type="text" id="ContactPhone2" asp-for="ContactPhone2" class="form-control" />


    <div class="form-group">
        <label asp-for="HouseDetail.Price">Gi√° thu√™</label>
        <input asp-for="HouseDetail.Price" class="form-control" />
        <span asp-validation-for="HouseDetail.Price" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="HouseDetail.DienTich">Di·ªán t√≠ch (m¬≤)</label>
        <input asp-for="HouseDetail.DienTich" class="form-control" />
        <span asp-validation-for="HouseDetail.DienTich" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="HouseDetail.TienDien">Ti·ªÅn ƒëi·ªán</label>
        <input asp-for="HouseDetail.TienDien" class="form-control" />
        <span asp-validation-for="HouseDetail.TienDien" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="HouseDetail.TienNuoc">Ti·ªÅn n∆∞·ªõc</label>
        <input asp-for="HouseDetail.TienNuoc" class="form-control" />
        <span asp-validation-for="HouseDetail.TienNuoc" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="HouseDetail.TienDv">Ti·ªÅn d·ªãch v·ª•</label>
        <input asp-for="HouseDetail.TienDv" class="form-control" />
        <span asp-validation-for="HouseDetail.TienDv" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="HouseDetail.Describe">M√¥ t·∫£</label>
        <textarea asp-for="HouseDetail.Describe" class="form-control"></textarea>
        <span asp-validation-for="HouseDetail.Describe" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label>Tr·∫°ng th√°i</label>

        <div class="form-check">
            <input type="radio" id="statusAvailable" name="HouseDetail.Status" class="form-check-input"
                value="Ch∆∞a cho thu√™" @(Model.HouseDetail.Status == "Ch∆∞a cho thu√™" ? "checked" : "") />
            <label class="form-check-label" for="statusAvailable">Ch∆∞a cho thu√™</label>
        </div>

        <div class="form-check">
            <input type="radio" id="statusRented" name="HouseDetail.Status" class="form-check-input" value="ƒê√£ cho thu√™"
                @(Model.HouseDetail.Status == "ƒê√£ cho thu√™" ? "checked" : "") />
            <label class="form-check-label" for="statusRented">ƒê√£ cho thu√™</label>
        </div>

        <span asp-validation-for="HouseDetail.Status" class="text-danger"></span>
    </div>


    <div class="form-group">
        <label for="imageFiles">H√¨nh ·∫£nh</label>
        <input type="file" class="form-control" id="imageFiles" name="imageFiles" multiple />

        @if (!string.IsNullOrEmpty(Model.HouseDetail?.Image))
        {
            <div class="mt-2" id="currentImages">
                <label>·∫¢nh hi·ªán t·∫°i:</label>
                <div class="d-flex flex-wrap">
                    @foreach (var imgUrl in Model.HouseDetail.Image.Split(','))
                    {
                        <div class="position-relative m-2">
                            <img src="@imgUrl" alt="·∫¢nh nh√† tr·ªç" style="max-width: 100px; height: 100px; object-fit: cover;" />
                            <button type="button" class="btn btn-danger btn-sm remove-image" data-img="@imgUrl">X</button>
                        </div>
                    }
                </div>
            </div>
            <input type="hidden" id="deletedImages" name="DeletedImages" value="" />
        }
    </div>

    <div class="form-group">
        <label>Ti·ªán √≠ch</label>
        @foreach (var amenity in Model.Amenities)
        {
            <div class="form-check">
                <input type="checkbox" name="SelectedAmenities" value="@amenity.IdAmenity" class="form-check-input"
                    @(Model.SelectedAmenities.Contains(amenity.IdAmenity) ? "checked" : "") />
                <label class="form-check-label">@amenity.Name</label>
            </div>
        }
    </div>

    <button type="submit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
    <a asp-action="ListHouseRoom" class="btn btn-secondary">H·ªßy</a>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="https://cdn.jsdelivr.net/npm/izitoast/dist/js/iziToast.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast/dist/css/iziToast.min.css">
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".remove-image").forEach(button => {
                button.addEventListener("click", function () {
                    let imgUrl = this.getAttribute("data-img");
                    let deletedImagesInput = document.getElementById("deletedImages");

                    // N·∫øu ·∫£nh ch∆∞a ƒë∆∞·ª£c th√™m v√†o danh s√°ch x√≥a, th√¨ th√™m v√†o
                    if (!deletedImagesInput.value.includes(imgUrl)) {
                        deletedImagesInput.value += deletedImagesInput.value ? `,${imgUrl}` : imgUrl;
                    }

                    this.parentElement.remove(); // X√≥a ·∫£nh kh·ªèi giao di·ªán
                });
            });

            // X·ª≠ l√Ω xem tr∆∞·ªõc ·∫£nh m·ªõi khi ch·ªçn file
            document.getElementById("imageFiles").addEventListener("change", function (event) {
                let previewContainer = document.getElementById("imagePreview");
                if (!previewContainer) {
                    previewContainer = document.createElement("div");
                    previewContainer.id = "imagePreview";
                    previewContainer.classList.add("mt-2", "d-flex", "flex-wrap");
                    this.parentElement.appendChild(previewContainer);
                }
                previewContainer.innerHTML = ""; // X√≥a ·∫£nh xem tr∆∞·ªõc c≈©

                Array.from(event.target.files).forEach(file => {
                    let reader = new FileReader();
                    reader.onload = function (e) {
                        let imgElement = document.createElement("img");
                        imgElement.src = e.target.result;
                        imgElement.style = "max-width: 100px; height: 100px; object-fit: cover; margin: 5px;";
                        previewContainer.appendChild(imgElement);
                    };
                    reader.readAsDataURL(file);
                });
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector("form");

            form.addEventListener("submit", function (event) {
                event.preventDefault(); // NgƒÉn ch·∫∑n submit m·∫∑c ƒë·ªãnh

                iziToast.show({
                    class: "iziToast-custom",
                    title: "üîî X√°c nh·∫≠n ch·ªânh s·ª≠a",
                    message: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ch·ªânh s·ª≠a b√†i ƒëƒÉng n√†y?",
                    position: "center",
                    timeout: false,
                    close: false,
                    overlay: true,
                    displayMode: "once",
                    drag: false,
                    icon: "fa fa-question-circle",
                    buttons: [
                        [
                            '<button><i class="fa fa-check"></i> L∆∞u</button>',
                            function (instance, toast) {
                                instance.hide({ transitionOut: "fadeOut" }, toast, "button");

                                fetch(form.action, {
                                    method: "POST",
                                    body: new FormData(form)
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            iziToast.success({
                                                title: "Th√†nh c√¥ng!",
                                                message: data.message,
                                                position: "topRight",
                                                timeout: 1000,
                                                onClosing: function () {
                                                    window.location.href = "/Home/Index";
                                                }
                                            });
                                        } else {
                                            iziToast.error({
                                                title: "L·ªói!",
                                                message: data.message || "C√≥ l·ªói x·∫£y ra!",
                                                position: "topRight"
                                            });
                                        }
                                    })
                                    .catch(() => {
                                        iziToast.error({
                                            title: "L·ªói!",
                                            message: "Kh√¥ng th·ªÉ l∆∞u thay ƒë·ªïi!",
                                            position: "topRight"
                                        });
                                    });
                            },
                            true
                        ],
                        [
                            '<button><i class="fa fa-times"></i> H·ªßy</button>',
                            function (instance, toast) {
                                instance.hide({ transitionOut: "fadeOut" }, toast, "button");
                            }
                        ]
                    ]
                });
            });
        });
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        const goongApiKey = "RJ9d6oO2TLx8s4Q8riMgne1hI905XhC89HxJ7fIy";

        $(document).ready(function () {
            $("#houseAddress").on("input", function () {
                let inputText = $(this).val().trim();
                if (inputText.length < 3) {
                    $("#addressSuggestions").empty();
                    return;
                }

                let apiUrl = `https://rsapi.goong.io/Place/AutoComplete?api_key=${goongApiKey}&input=${encodeURIComponent(inputText)}`;

                $.getJSON(apiUrl, function (data) {
                    $("#addressSuggestions").empty();
                    if (data.predictions) {
                        data.predictions.forEach(item => {
                            let listItem = `<li class="list-group-item address-item" data-address="${item.description}">${item.description}</li>`;
                            $("#addressSuggestions").append(listItem);
                        });
                        $("#addressSuggestions").show(); // Hi·ªÉn th·ªã g·ª£i √Ω
                    }
                });
            });

            // Khi ng∆∞·ªùi d√πng ch·ªçn m·ªôt ƒë·ªãa ch·ªâ g·ª£i √Ω
            $(document).on("click", ".address-item", function () {
                let selectedAddress = $(this).data("address");
                $("#houseAddress").val(selectedAddress);
                $("#addressSuggestions").empty().hide(); // ·∫®n danh s√°ch sau khi ch·ªçn
            });

            // ·∫®n khung g·ª£i √Ω khi click ra ngo√†i
            $(document).click(function (event) {
                if (!$(event.target).closest("#houseAddress, #addressSuggestions").length) {
                    $("#addressSuggestions").empty().hide();
                }
            });
        });

    </script>
}
