@model KLTN.ViewModels.HousePostViewModel

<link rel="stylesheet" href="~/css/create.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/House/create.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/iziToast.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<form asp-action="Create" method="post" enctype="multipart/form-data" id="createHouseForm" target="_top">
    <div class="section">
        <h4>Th√¥ng tin li√™n h·ªá</h4>

        <!-- Tr∆∞·ªùng li√™n h·ªá th·ª© 2 (c√≥ th·ªÉ ƒë·ªÉ tr·ªëng) -->
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label asp-for="HouseDetail.ContactName2">Ng∆∞·ªùi li√™n h·ªá 2</label>
                    <input asp-for="HouseDetail.ContactName2" class="form-control"
                        placeholder="T√™n ng∆∞·ªùi li√™n h·ªá (VD: Nguy·ªÖn VƒÉn A)" />
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label asp-for="HouseDetail.ContactPhone2">S·ªë li√™n h·ªá 2</label>
                    <input asp-for="HouseDetail.ContactPhone2" class="form-control"
                        placeholder="S·ªë ƒëi·ªán tho·∫°i (VD: 0912345678)" />
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <h4>Th√¥ng tin chi ti·∫øt</h4>
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label asp-for="HouseDetail.DienTich">Di·ªán t√≠ch (m¬≤) *</label>
                    <input asp-for="HouseDetail.DienTich" class="form-control" placeholder="Di·ªán t√≠ch (VD: 25)" />
                    <span asp-validation-for="HouseDetail.DienTich" class="text-danger"></span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label asp-for="HouseDetail.Price">Gi√° thu√™ (VNƒê/th√°ng) *</label>
                    <input asp-for="HouseDetail.Price" class="form-control" placeholder="Gi√° thu√™ (VD: 3.000.000)" />
                    <span asp-validation-for="HouseDetail.Price" class="text-danger"></span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label asp-for="House.NameHouse">Ti√™u ƒë·ªÅ *</label>
                    <input asp-for="House.NameHouse" class="form-control"
                        placeholder="Ti√™u ƒë·ªÅ (VD: Ph√≤ng tr·ªç gi√° r·∫ª)" />
                    <span asp-validation-for="House.NameHouse" class="text-danger"></span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label asp-for="HouseDetail.TienDien">Gi√° ƒëi·ªán (vnƒë/kwh) *</label>
                    <input asp-for="HouseDetail.TienDien" class="form-control" placeholder="Gi√° ƒëi·ªán (VD: 3.500)" />
                    <span asp-validation-for="HouseDetail.TienDien" class="text-danger"></span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label asp-for="HouseDetail.TienNuoc">Gi√° n∆∞·ªõc (vnƒë/m¬≥) *</label>
                    <input asp-for="HouseDetail.TienNuoc" class="form-control" placeholder="Gi√° n∆∞·ªõc (VD: 10.000)" />
                    <span asp-validation-for="HouseDetail.TienNuoc" class="text-danger"></span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label asp-for="HouseDetail.Describe">M√¥ t·∫£ *</label>
                    <textarea asp-for="HouseDetail.Describe" class="form-control" rows="5"
                        placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ nh√† tr·ªç (VD: Ph√≤ng r·ªông r√£i, c√≥ ban c√¥ng...)"></textarea>
                    <span asp-validation-for="HouseDetail.Describe" class="text-danger"></span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label>Ti·ªÅn c·ªçc (VNƒê)</label>
                    <input type="text" class="form-control" placeholder="Ti·ªÅn c·ªçc (VD: 1.000.000)" />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label>Lo·∫°i nh√† tr·ªç *</label>
                    <select asp-for="SelectedHouseType" asp-items="Model.HouseTypes" class="form-control">
                        <option value="">-- Ch·ªçn lo·∫°i nh√† tr·ªç --</option>
                    </select>
                    <span asp-validation-for="SelectedHouseType" class="text-danger"></span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label asp-for="HouseDetail.TienDv">Gi√° d·ªãch v·ª• kh√°c</label>
                    <input asp-for="HouseDetail.TienDv" class="form-control" placeholder="Gi√° d·ªãch v·ª• (VD: 100.000)" />
                    <span asp-validation-for="HouseDetail.TienDv" class="text-danger"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <h4>ƒê·ªãa ch·ªâ</h4>
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="province">T·ªânh/Th√†nh ph·ªë</label>
                    <select id="province" class="form-control">
                    </select>
                    <span id="provinceError" class="text-danger"></span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="district">Qu·∫≠n/Huy·ªán</label>
                    <select id="district" class="form-control">
                        <option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>
                    </select>
                    <span id="districtError" class="text-danger"></span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="ward">Ph∆∞·ªùng/X√£</label>
                    <select id="ward" class="form-control">
                        <option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>
                    </select>
                    <span id="wardError" class="text-danger"></span>
                </div>
            </div>
        </div>
        <div class="mt-2">
            <label for="fullAddress">ƒê·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß *</label>
            <input type="text" id="fullAddress" class="form-control required"
                placeholder="ƒê·ªãa ch·ªâ c·ª• th·ªÉ (VD: 96 ƒê·ªãnh C√¥ng)" required />
            <ul id="addressSuggestions" class="list-group"></ul>
            <span id="fullAddressError" class="text-danger"></span>
        </div>
        <input type="hidden" id="address" name="HouseDetail.Address" />
    </div>

    <div class="section">
        <h4>Ti·ªán √≠ch</h4>
        <div class="amenities-container">
            <div class="row">
                @foreach (var amenity in Model.Amenities)
                {
                    <div class="col-md-4">
                        <div class="form-check">
                            <input type="checkbox" name="SelectedAmenities" value="@amenity.IdAmenity"
                                class="form-check-input" @(Model.SelectedAmenities?.Contains(amenity.IdAmenity) == true ?
                                "checked" : "") />
                        <label class="form-check-label">@amenity.Name</label>
                    </div>
                </div>
                                }
            </div>
        </div>
    </div>

    <input type="hidden" name="HouseDetail.Status" value="Ch∆∞a cho thu√™" />

    <div class="section d-none">
        <h4>Tr·∫°ng th√°i</h4>
        <div class="form-check">
            <input type="radio" id="statusAvailable" name="HouseDetail.Status" class="form-check-input"
                value="Ch∆∞a cho thu√™" @(Model.HouseDetail.Status == "Ch∆∞a cho thu√™" ? "checked" : "") />
            <label class="form-check-label" for="statusAvailable">Ch∆∞a cho thu√™</label>
        </div>

        <div class="form-check">
            <input type="radio" id="statusRented" name="HouseDetail.Status" class="form-check-input" value="ƒê√£ cho thu√™"
                @(Model.HouseDetail.Status == "ƒê√£ cho thu√™" ? "checked" : "") />
            <label class="form-check-label" for="statusRented">ƒê√£ cho thu√™</label>
        </div>

        <span asp-validation-for="HouseDetail.Status" class="text-danger"></span>
    </div>

    <div class="section">
        <h4>H√¨nh ·∫£nh</h4>
        <div class="form-group">
            <label asp-for="HouseDetail.Image">H√¨nh ·∫£nh nh√† tr·ªç</label>
            <input asp-for="HouseDetail.Image" type="file" class="form-control" name="imageFile" id="imageFile" />
            <div class="image-preview mt-2" id="imagePreview">
                @if (!string.IsNullOrEmpty(Model.HouseDetail.Image))
                {
                    <img src="~/@Model.HouseDetail.Image" alt="·∫¢nh c·ªßa nh√† tr·ªç" style="max-width: 200px;" />
                }
            </div>
            <span asp-validation-for="HouseDetail.Image" class="text-danger"></span>
        </div>
    </div>

    <div class="row button-row">
        <div class="col-md-12 text-center">
            <button type="submit" class="btn btn-primary">L∆∞u</button>
        </div>
    </div>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast/dist/css/iziToast.min.css">
<script src="https://cdn.jsdelivr.net/npm/izitoast/dist/js/iziToast.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
    const goongApiKey = "RJ9d6oO2TLx8s4Q8riMgne1hI905XhC89HxJ7fIy";

    $(document).ready(function () {
        const apiBase = "https://provinces.open-api.vn/api/";

        // Ki·ªÉm tra API c√≥ ph·∫£n h·ªìi ƒë√∫ng kh√¥ng
        $.get(apiBase + "?depth=1", function (data) {
            console.log("Danh s√°ch t·ªânh/th√†nh ph·ªë:", data); // Log d·ªØ li·ªáu ra Console
            if (data.length > 0) {
                $("#province").append('<option value="">-- Ch·ªçn T·ªânh/Th√†nh --</option>');
                data.forEach(province => {
                    $("#province").append(new Option(province.name, province.code));
                });
            } else {
                console.error("API kh√¥ng tr·∫£ v·ªÅ d·ªØ li·ªáu!");
            }
        }).fail(function () {
            console.error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch t·ªânh/th√†nh! L·ªói API.");
        });

        // Khi ch·ªçn t·ªânh, load danh s√°ch qu·∫≠n/huy·ªán
        $("#province").change(function () {
            let provinceId = $(this).val();
            $("#district").empty().append('<option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>');
            $("#ward").empty().append('<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>');
            $("#provinceError").text('');

            if (provinceId) {
                $.get(apiBase + "p/" + provinceId + "?depth=2", function (data) {
                    console.log("Danh s√°ch qu·∫≠n/huy·ªán:", data.districts);
                    if (data.districts.length > 0) {
                        data.districts.forEach(district => {
                            $("#district").append(new Option(district.name, district.code));
                        });
                    } else {
                        console.warn("Kh√¥ng c√≥ qu·∫≠n/huy·ªán n√†o cho t·ªânh n√†y!");
                    }
                }).fail(function () {
                    console.error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch qu·∫≠n/huy·ªán! L·ªói API.");
                });
            }
        });

        // Khi ch·ªçn qu·∫≠n/huy·ªán, load danh s√°ch ph∆∞·ªùng/x√£
        $("#district").change(function () {
            let districtId = $(this).val();
            $("#ward").empty().append('<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>');
            $("#districtError").text('');

            if (districtId) {
                $.get(apiBase + "d/" + districtId + "?depth=2", function (data) {
                    console.log("Danh s√°ch ph∆∞·ªùng/x√£:", data.wards);
                    if (data.wards.length > 0) {
                        data.wards.forEach(ward => {
                            $("#ward").append(new Option(ward.name, ward.code));
                        });
                    } else {
                        console.warn("Kh√¥ng c√≥ ph∆∞·ªùng/x√£ n√†o cho qu·∫≠n n√†y!");
                    }
                }).fail(function () {
                    console.error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch ph∆∞·ªùng/x√£! L·ªói API.");
                });
            }
        });

        // Khi ch·ªçn xong, c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ v√†o input ·∫©n
        $("#ward").change(function () {
            $("#wardError").text('');
            updateAddress();
        });

        // Khi ng∆∞·ªùi d√πng nh·∫≠p ƒë·ªãa ch·ªâ c·ª• th·ªÉ, c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß
        $("#fullAddress").keyup(function () {
            $("#fullAddressError").text('');
            updateAddress();
        });

        function updateAddress() {
            let province = $("#province option:selected").text();
            let district = $("#district option:selected").text();
            let ward = $("#ward option:selected").text();
            let specificAddress = $("#fullAddress").val().trim();

            // Ki·ªÉm tra n·∫øu l√† gi√° tr·ªã m·∫∑c ƒë·ªãnh th√¨ kh√¥ng th√™m v√†o ƒë·ªãa ch·ªâ
            province = province === "-- Ch·ªçn T·ªânh/Th√†nh --" ? "" : province;
            district = district === "-- Ch·ªçn Qu·∫≠n/Huy·ªán --" ? "" : district;
            ward = ward === "-- Ch·ªçn Ph∆∞·ªùng/X√£ --" ? "" : ward;

            // Ki·ªÉm tra gi√° tr·ªã nh·∫≠p v√†o (debugging)
            console.log("Gi√° tr·ªã ƒë·ªãa ch·ªâ nh·∫≠p tay:", specificAddress);

            let fullAddress = "";

            if (specificAddress.includes(",") && ($("#province").val() || $("#district").val() || $("#ward").val())) {
                specificAddress = "";
                $("#fullAddress").val(""); // X√≥a input nh·∫≠p tay
            }

            let addressParts = [specificAddress, ward, district, province].filter(part => part !== "");
            fullAddress = addressParts.join(", ");

            $("#address").val(fullAddress);
            console.log("ƒê·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß:", fullAddress);
        }

        // X·ª≠ l√Ω xem tr∆∞·ªõc h√¨nh ·∫£nh
        $("#imageFile").change(function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    $('#imagePreview').html('<img src="' + e.target.result + '" alt="Preview" style="max-width: 200px;" />');
                }
                reader.readAsDataURL(file);
            }
        });

        $(document).ready(function () {
            $("#createHouseForm").submit(function (e) {
                e.preventDefault(); // NgƒÉn ch·∫∑n form submit ngay l·∫≠p t·ª©c

                let isValid = true;
                $(".text-danger").text(""); // X√≥a th√¥ng b√°o l·ªói c≈©

                if (!$("#fullAddress").val().trim()) {
                    $("#fullAddressError").text("Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ c·ª• th·ªÉ");
                    isValid = false;
                }
                if (!$("#House_NameHouse").val().trim()) {
                    $("#House_NameHouse").next(".text-danger").text("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ!");
                    isValid = false;
                }

                let dienTich = parseFloat($("#HouseDetail_DienTich").val());
                if (isNaN(dienTich) || dienTich < 0) {
                    $("#HouseDetail_DienTich").next(".text-danger").text("Di·ªán t√≠ch ph·∫£i l√† s·ªë d∆∞∆°ng!");
                    isValid = false;
                }

                let price = parseFloat($("#HouseDetail_Price").val().replace(/\D/g, ''));
                if (isNaN(price) || price < 0) {
                    $("#HouseDetail_Price").next(".text-danger").text("Gi√° thu√™ ph·∫£i l√† s·ªë d∆∞∆°ng!");
                    isValid = false;
                }

                // Ki·ªÉm tra gi√° ƒëi·ªán, gi√° n∆∞·ªõc, gi√° d·ªãch v·ª• (ph·∫£i l√† s·ªë d∆∞∆°ng)
                let tienDien = parseFloat($("#HouseDetail_TienDien").val());
                let tienNuoc = parseFloat($("#HouseDetail_TienNuoc").val());
                let tienDv = parseFloat($("#HouseDetail_TienDv").val());

                if (isNaN(tienDien) || tienDien < 0) {
                    $("#HouseDetail_TienDien").next(".text-danger").text("Gi√° ƒëi·ªán ph·∫£i l√† s·ªë d∆∞∆°ng!");
                    isValid = false;
                }
                if (isNaN(tienNuoc) || tienNuoc < 0) {
                    $("#HouseDetail_TienNuoc").next(".text-danger").text("Gi√° n∆∞·ªõc ph·∫£i l√† s·ªë d∆∞∆°ng!");
                    isValid = false;
                }
                if (isNaN(tienDv) || tienDv < 0) {
                    $("#HouseDetail_TienDv").next(".text-danger").text("Gi√° d·ªãch v·ª• ph·∫£i l√† s·ªë d∆∞∆°ng!");
                    isValid = false;
                }

                // Ki·ªÉm tra lo·∫°i nh√† tr·ªç (b·∫Øt bu·ªôc ch·ªçn)
                if (!$("#SelectedHouseType").val()) {
                    $("#SelectedHouseType").next(".text-danger").text("Vui l√≤ng ch·ªçn lo·∫°i nh√† tr·ªç!");
                    isValid = false;
                }

                // Ki·ªÉm tra h√¨nh ·∫£nh (b·∫Øt bu·ªôc t·∫£i l√™n √≠t nh·∫•t m·ªôt ·∫£nh)
                if (!$("#imageFile").val()) {
                    $("#imageFile").next(".text-danger").text("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h√¨nh ·∫£nh!");
                    isValid = false;
                }

                if (!isValid) {
                    e.preventDefault();

                    // Cu·ªôn ƒë·∫øn l·ªói ƒë·∫ßu ti√™n
                    const firstError = $(".text-danger").filter(function () {
                        return $(this).text() !== "";
                    }).first();

                    if (firstError.length) {
                        $('html, body').animate({
                            scrollTop: firstError.offset().top - 100
                        }, 500);
                    }
                    return;
                }
                let freePostsRemaining = @Model.FreePostsRemaining;

                if (freePostsRemaining > 0) {
                    // N·∫øu c√≤n l∆∞·ª£t mi·ªÖn ph√≠, h·ªèi ng∆∞·ªùi d√πng c√≥ mu·ªën d√πng kh√¥ng
                    iziToast.question({
                        class: 'iziToast-custom',
                        timeout: 20000,
                        close: false,
                        overlay: true,
                        title: 'üîî S·ª≠ d·ª•ng b√†i ƒëƒÉng mi·ªÖn ph√≠?',
                        message: `B·∫°n c√≤n ${freePostsRemaining} b√†i ƒëƒÉng mi·ªÖn ph√≠. B·∫°n c√≥ mu·ªën s·ª≠ d·ª•ng kh√¥ng?`,
                        position: 'center',
                        icon: "fa fa-question-circle",
                        buttons: [
                            ['<button><i class="fa fa-check"></i> C√≥</button>', function (instance, toast) {
                                instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                                $("#createHouseForm")[0].submit();
                            }, true],
                            ['<button><i class="fa fa-times"></i> Kh√¥ng</button>', function (instance, toast) {
                                instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                            }]
                        ]
                    });
                } else {
                    // N·∫øu h·∫øt l∆∞·ª£t mi·ªÖn ph√≠, th√¥ng b√°o ph√≠ 
                    iziToast.question({
                        class: 'iziToast-custom',
                        timeout: 20000,
                        close: false,
                        overlay: true,
                        title: 'üîî X√°c nh·∫≠n thanh to√°n',
                        message: 'B·∫°n ƒë√£ h·∫øt l∆∞·ª£t ƒëƒÉng mi·ªÖn ph√≠. Ph√≠ ƒëƒÉng b√†i l√† 50.000 VNƒê/b√†i. B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c kh√¥ng?',
                        position: 'center',
                        icon: "fa fa-question-circle",
                        buttons: [
                            ['<button><i class="fa fa-check"></i> ƒê·ªìng √Ω</button>', function (instance, toast) {
                                instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                                $("#createHouseForm")[0].submit(); // G·ª≠i form
                            }, true],
                            ['<button><i class="fa fa-times"></i> H·ªßy</button>', function (instance, toast) {
                                instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                            }]
                        ]
                    });
                }
            });
        });
    });

    // G·ª£i √Ω ƒë·ªãa ch·ªâ
    $(document).ready(function () {
        $("#fullAddress").on("input", function () {
            let inputText = $(this).val().trim();
            if (inputText.length < 3) {
                $("#addressSuggestions").empty();
                return;
            }

            let apiUrl = `https://rsapi.goong.io/Place/AutoComplete?api_key=${goongApiKey}&input=${encodeURIComponent(inputText)}`;

            $.getJSON(apiUrl, function (data) {
                $("#addressSuggestions").empty();
                if (data.predictions) {
                    data.predictions.forEach(item => {
                        let listItem = `<li class="list-group-item address-item" data-address="${item.description}">${item.description}</li>`;
                        $("#addressSuggestions").append(listItem);
                    });
                }
            });
        });

        // Khi ng∆∞·ªùi d√πng ch·ªçn m·ªôt ƒë·ªãa ch·ªâ g·ª£i √Ω
        $(document).on("click", ".address-item", function () {
            let selectedAddress = $(this).data("address");
            $("#fullAddress").val(selectedAddress);
            $("#addressSuggestions").empty();
            $("#address").val(selectedAddress); // L∆∞u v√†o input ·∫©n

            $("#province").val("").trigger("change");
            $("#district").empty().append('<option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>');
            $("#ward").empty().append('<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>');
        });
        
        $(document).on("click", function (event) {
            if (!$(event.target).closest("#fullAddress, #addressSuggestions").length) {
                $("#addressSuggestions").empty(); // ·∫®n g·ª£i √Ω khi nh·∫•n ra ngo√†i
            }
        });
    });
</script>
