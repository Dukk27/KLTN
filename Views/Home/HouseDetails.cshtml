@model KLTN.Models.House

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    int userRole = ViewBag.UserRole;

    var amenityIcons = new Dictionary<string, string>
    {
        { "ƒêi·ªÅu h√≤a", "fas fa-snowflake" },
        { "N√≥ng l·∫°nh", "fas fa-temperature-high" },
        { "Gi∆∞·ªùng", "fas fa-bed" },
        { "T·ªß ƒë·ªì", "fas fa-person-booth" },
        { "M√°y gi·∫∑t", "fas fa-sync-alt" },
        { "B√†n b·∫øp", "fas fa-utensils" },
        { "Thi·∫øt b·ªã v·ªá sinh", "fas fa-toilet" },
        { "Thang m√°y", "fas fa-arrow-up" },
        { "Ch·ªó ƒë·ªÉ xe", "fas fa-parking" },
        { "Wifi", "fas fa-wifi" },
        { "S√¢n ph∆°i", "fas fa-tshirt" },
        { "V·ªá sinh chung", "fas fa-restroom" },
        { "Ban c√¥ng", "fas fa-building" },
        { "C·ª≠a s·ªï", "fas fa-window-maximize" },
        { "G√°c", "fas fa-layer-group" },
        { "T·∫ßng th∆∞·ª£ng", "fas fa-building" },
        { "PCCC", "fas fa-fire-extinguisher" },
        { "Camera an ninh", "fas fa-video" },
        { "Kho√° v√¢n tay", "fas fa-fingerprint" },
        { "Kh√¥ng chung ch·ªß", "fas fa-user-slash" },
        { "Gi·ªù gi·∫•c t·ª± do", "fas fa-clock" },
        { "V·ªá sinh kh√©p k√≠n", "fas fa-shower" }
    };
}

@if (TempData["SuccessMessage"] != null)
{
    <script src="https://cdn.jsdelivr.net/npm/izitoast/dist/js/iziToast.min.js"></script>
    <script>
        iziToast.success({
            title: 'Th√†nh c√¥ng!',
            message: '@TempData["SuccessMessage"]',
            position: 'topRight',
            timeout: 2000,
        });
    </script>
}

@if (TempData["ErrorMessage"] != null)
{
    <script src="https://cdn.jsdelivr.net/npm/izitoast/dist/js/iziToast.min.js"></script>
    <script>
        iziToast.error({
            title: 'L·ªói!',
            message: '@TempData["ErrorMessage"]',
            position: 'topRight',
            timeout: 2000,
        });
    </script>
}
@{
    var otherHousesList = ViewBag.OtherHouses as List<KLTN.Models.House>;
    var showNavigation = otherHousesList != null && otherHousesList.Count > 5;
}

<head>
    <title>Chi Ti·∫øt Nh√†</title>
    <link rel="stylesheet" href="~/css/Detail/Detail.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/index.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" />
    <link rel="stylesheet" href="~/css/goong-js.css" asp-append-version="true" />
    <input type="hidden" id="Latitude" name="Lat" />
    <input type="hidden" id="Longitude" name="Lng" />
    <!-- Slick CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css"/>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Slick JS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
</head> 

<body>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                @if (ViewBag.UserRole == 0) 
                {
                    <a href="@Url.Action("Index", "Admin")">Trang Ch·ªß Admin</a>
                }
                else
                {
                    <a href="@Url.Action("Index", "Home")">Trang Ch·ªß</a>
                }
            </li>
            <li class="breadcrumb-item active" aria-current="page">Th√¥ng Tin Chi Ti·∫øt B√†i ƒêƒÉng Nh√† Tr·ªç "@Model.NameHouse"
            </li>
        </ol>
    </nav>

    <div class="detail-container">
        <h1>@Model.NameHouse</h1>

        <label class="section-title">Th√¥ng Tin Chi Ti·∫øt</label>
        <div class="section-underline"></div>
        <div class="detail-content">
            <div id="houseImageCarousel" class="carousel slide" data-bs-interval="false">
                <div class="carousel-indicators">
                    @{
                        int i = 0;
                        foreach (var detail in Model.HouseDetails)
                        {
                            foreach (var image in detail.Image.Split(',', StringSplitOptions.RemoveEmptyEntries))
                            {
                                <button type="button" data-bs-target="#houseImageCarousel" data-bs-slide-to="@i"
                                        class="@(i == 0 ? "active" : "")" aria-current="@(i == 0 ? "true" : null)"
                                        aria-label="Slide @(i + 1)"></button>;
                                i++;
                            } 
                        }
                    }
                </div>

                <div class="carousel-inner">
                    @{
                        int index = 0;
                        foreach (var detail in Model.HouseDetails)
                        {
                            foreach (var image in detail.Image.Split(',', StringSplitOptions.RemoveEmptyEntries))
                            {
                                <div class="carousel-item @(index == 0 ? "active" : "")">
                                    <img src="@image" class="d-block w-100 preview-image" alt="H√¨nh ·∫£nh nh√†"
                                        onclick="openFullSizeImage(this)">
                                </div>
                                index++;
                            }
                        } 
                    }
                </div>
                <!-- N√∫t ƒëi·ªÅu h∆∞·ªõng -->
                <button class="carousel-control-prev" type="button" data-bs-target="#houseImageCarousel"
                    data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#houseImageCarousel"
                    data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>

            <div class="house-info">
                @foreach (var detail in Model.HouseDetails)
                {
                    var timeDiffNullable = DateTime.Now - detail.TimeUpdate;
                    var timeDiff = timeDiffNullable.HasValue ? timeDiffNullable.Value : TimeSpan.Zero;
                    string timeDisplay = "";

                    if (timeDiff.TotalMinutes < 1)
                    {
                        timeDisplay = "V·ª´a xong";
                    }
                    else if (timeDiff.TotalMinutes < 60)
                    {
                        timeDisplay = $"{(int)timeDiff.TotalMinutes} ph√∫t tr∆∞·ªõc";
                    }
                    else if (timeDiff.TotalHours < 24)
                    {
                        timeDisplay = $"{(int)timeDiff.TotalHours} gi·ªù tr∆∞·ªõc";
                    }
                    else
                    {
                        timeDisplay = $"{(int)timeDiff.TotalDays} ng√†y tr∆∞·ªõc";
                    }

                    <div class="address-box mb-3">
                        <p style="font-size: 18px;">
                            <strong>ƒê·ªãa ch·ªâ:</strong>
                            <span>@detail.Address</span>
                        </p>
                    </div>

                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <td><i class="fas fa-home" style="color: #6f42c1;"></i><strong>Lo·∫°i nh√† tr·ªç</strong></td>
                                <td>@Model.HouseType?.Name</td>
                                <td><i class="fas fa-money-bill" style="color: #28a745;"></i><strong>Gi√° ti·ªÅn</strong></td>
                                <td>@detail.Price.ToString("#,0", new System.Globalization.CultureInfo("vi-VN")) VND/Th√°ng</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-user" style="color: #007bff;"></i><strong>Ng∆∞·ªùi li√™n h·ªá 1</strong></td>
                                <td>@Model.IdUserNavigation?.UserName</td>
                                <td><i class="fas fa-phone" style="color: #17a2b8;"></i> <strong>S·ªë ƒëi·ªán tho·∫°i</strong></td>
                                <td colspan="3">@Model.IdUserNavigation?.PhoneNumber</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-user" style="color: #007bff;"></i><strong>Ng∆∞·ªùi li√™n h·ªá 2</strong></td>
                                <td>@detail.ContactName2</td>
                                <td><i class="fas fa-phone" style="color: #17a2b8;"></i> <strong>S·ªë ƒëi·ªán tho·∫°i 2</strong></td>
                                <td colspan="3">@detail.ContactPhone2</td>
                            </tr>
                            <tr>
                                <td> <i class="fas fa-ruler-combined" style="color: #6c757d;"></i><strong>Di·ªán t√≠ch</strong>
                                </td>
                                <td>@detail.DienTich m¬≤</td>
                                <td><i class="fas fa-bolt" style="color: #ffc107;"></i><strong> Ti·ªÅn ƒëi·ªán</strong></td>
                                <td>@detail.TienDien </td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-tint" style="color: #17a2b8;"></i> <strong>Ti·ªÅn n∆∞·ªõc</strong></td>
                                <td>@detail.TienNuoc </td>
                                <td><i class="fas fa-coins" style="color: #dc3545;"></i><strong>Ti·ªÅn d·ªãch v·ª•</strong></td>
                                <td>@detail.TienDv VND/Th√°ng</td>
                            </tr>

                            <tr>
                                <td> <i class="fas fa-check-circle" style="color: #28a745;"></i><strong>Tr·∫°ng th√°i</strong></td>
                                <td>
                                    @if (detail.Status == "Ch∆∞a cho thu√™")
                                    {
                                        <span class="status-not-rented">C√≤n ph√≤ng</span>
                                    }
                                    else if (detail.Status == "ƒê√£ cho thu√™")
                                    {
                                        <span class="status-rented">ƒê√£ cho thu√™</span>
                                    }
                                </td>
                                <td> <i class="fas fa-calendar" style="color: #007bff;"></i><strong>Ng√†y ƒëƒÉng</strong></td>
                                <td>@detail.TimePost.ToString("dd/MM/yyyy")</td>
                            </tr>
                            <tr>
                                <td> <i class="fas fa-info-circle" style="color: #343a40;"></i> <strong>M√¥ t·∫£</strong></td>
                                <td colspan="3">@detail.Describe</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="address-box mb-3">
                        <p style="font-size: 18px; font-style: italic">
                            <strong>C·∫≠p nh·∫≠t:</strong>
                            <span>@timeDisplay</span>
                        </p>
                    </div>

                    @if (Model.Reviews != null && Model.Reviews.Any())
                    {
                        var avgRating = Model.Reviews.Average(r => r.Rating);
                        var roundedRating = Math.Round(avgRating, 1); // l√†m tr√≤n 1 s·ªë th·∫≠p ph√¢n

                        <div class="address-box mb-3">
                            <p style="font-size: 18px; font-style: italic">
                                <strong>ƒê√°nh gi√° trung b√¨nh:</strong> 
                                <span>@roundedRating <i class="fa fa-star text-warning"></i></span> 
                                (<span>@Model.Reviews.Count() ƒë√°nh gi√°</span>)
                            </p>
                        </div>
                    }
                    else
                    {
                        <div class="address-box mb-3">
                            <p style="font-size: 18px; font-style: italic">
                                <strong>B√†i ƒëƒÉng ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</strong>
                            </p>
                        </div>
                    }
                }
            </div>
        </div>

        <!--Chat v√† ƒê·∫∑t h·∫πn-->
        <div class="action-buttons">
            @if (ViewBag.OwnerId != ViewBag.CurrentUserId && ViewBag.IsOwnerLocked == false)
            {
                <a href="javascript:void(0);" onclick="handleChatClick()" class="btn btn-search">
                    <i class="fas fa-comment"></i> Nh·∫Øn Tin v·ªõi Ch·ªß Tr·ªç
                </a>
                <button id="bookAppointmentBtn" class="btn btn-search"><i class="fas fa-calendar"></i> ƒê·∫∑t l·ªãch h·∫πn</button>
            }
            else if (ViewBag.OwnerId != ViewBag.CurrentUserId && ViewBag.IsOwnerLocked == true)
            {
                <p class="text-danger mt-2">üîí Ch·ªß tr·ªç hi·ªán ƒëang b·ªã kh√≥a t√†i kho·∫£n, kh√¥ng th·ªÉ nh·∫Øn tin ho·∫∑c ƒë·∫∑t l·ªãch h·∫πn.</p>
            }

            <!-- Form ƒë·∫∑t l·ªãch h·∫πn (popup) -->
            <div id="appointmentOverlay" class="appointment-overlay"></div>
            <div id="appointmentForm" class="appointment-form">
                <h3>ƒê·∫∑t L·ªãch H·∫πn Xem Nh√†</h3>

                <div class="form-group">
                    <label for="appointmentDateTime">Th·ªùi gian h·∫πn g·∫∑p <span style="color:red">*</span></label>
                    <input type="datetime-local" id="appointmentDateTime" required>
                </div>

                <div class="form-group">
                    <label for="appointmentLocation">ƒê·ªãa ƒëi·ªÉm h·∫πn</label>
                    <input type="text" id="appointmentLocation" readonly class="form-control" />
                </div>
 
                <div class="note">
                    <p>B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c email khi ch·ªß nh√† x√°c nh·∫≠n l·ªãch h·∫πn v·ªõi n·ªôi dung: B·∫°n c√≥ l·ªãch h·∫πn v·ªõi <strong>[H·ªç v√† t√™n]</strong> t·∫°i <strong>[ƒê·ªãa ƒëi·ªÉm h·∫πn]</strong> v√†o <strong>[Th·ªùi gian h·∫πn g·∫∑p]</strong>.</p>
                </div>

                <div class="appointment-buttons">
                    <button id="closeForm" class="btn btn-secondary">ƒê√≥ng</button>
                    <button id="submitAppointment" class="btn custom-confirm-btn">ƒê·∫∑t l·ªãch</button>
                </div>
            </div>

            <input type="hidden" id="isAuthenticated" value="@User.Identity.IsAuthenticated.ToString().ToLower()" />
            <input type="hidden" id="userRole" value="@ViewBag.UserRole" />
            <input type="hidden" id="houseOwnerId" value="@Model.IdUserNavigation.IdUser" />
            <input type="hidden" id="currentUserId" value="@ViewBag.currentUserId" />
        </div>

        <label class="section-title">Ti·ªán √çch</label>
        <div class="section-underline"></div>
        <div class="row amenities-wrapper">
            @foreach (var amenity in Model.IdAmenities)
            {
                var iconClass = amenityIcons.ContainsKey(amenity.Name) ? amenityIcons[amenity.Name] : "fas fa-wind";

                <div class="col-md-3 col-sm-6 col-12 mb-3">
                    <div class="amenity-item">
                        <i class="@iconClass" style="margin-right: 5px; margin-bottom: 20px"></i> @amenity.Name
                    </div>
                </div>
            }
        </div>

        <input type="hidden" id="house-address" data-address="@Model.HouseDetails.FirstOrDefault()?.Address" />

        <!-- B·∫£n ƒë·ªì -->
        <label class="section-title">B·∫£n ƒê·ªì V·ªã Tr√≠</label>
        <div class="section-underline"></div>

        <div id="map" style="width: 100%; height: 500px; position: relative;">
            <div class="map-style-button" onclick="toggleMapStyleMenu()">Map Styles</div>

            <div class="map-style-menu">
                <button onclick="changeMapStyle('light')">Light</button>
                <button onclick="changeMapStyle('dark')">Dark</button>
                <button onclick="changeMapStyle('navigation-day')">Navigation Day</button>
                <button onclick="changeMapStyle('navigation-night')">Navigation Night</button>
                <button onclick="changeMapStyle('default')">Default</button>
            </div>
 
            <div id="directions-icon" class="map-icon" onclick="getDirections()">
                <i class="fa fa-directions"></i>
                <span class="icon-text">Get Directions</span>
            </div>
            <div id="locate-icon" class="map-icon" onclick="locateUser()">
                <i class="fa fa-location-arrow"></i>
                <span class="icon-text">Locate Me</span>
            </div>

        </div>

        <label class="section-title">ƒê√°nh gi√°</label>
        <div class="section-underline"></div>

        <div class="review-section">
            @if (Model.Reviews != null && Model.Reviews.Any())
            {
                <ul class="review-list">
                @foreach (var review in Model.Reviews.Where(r => !r.IdUserNavigation.IsLocked))
                    { 
                        <li class="review-item">
                            <!-- T√™n ng∆∞·ªùi ƒë√°nh gi√°, Ng√†y ƒë√°nh gi√° v√† Rating (S·ªë sao) c√πng n·∫±m tr√™n 1 h√†ng -->
                            <div class="review-header">
                                <strong>@review.IdUserNavigation.UserName</strong>
                                <span class="review-date">@review.ReviewDate?.ToString("dd/MM/yyyy HH:mm")</span>
                                <span class="review-rating">Rating: @review.Rating ‚òÖ</span>
                            </div>
                            
                            <!-- N·ªôi dung comment n·∫±m d∆∞·ªõi t√™n, ng√†y ƒë√°nh gi√° v√† rating -->
                            <p class="review-content">@review.Content</p>
                        </li>
                    }
                </ul>
            }
            else
            {
                <p style="font-size: 20px; text-align: center">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>
            }
        </div>

        @if (ViewBag.OwnerId != ViewBag.CurrentUserId)
        {
            <div class="review-form" data-house-id="@Model?.IdHouse">
                <div class="review-input-wrapper">
                    <textarea id="Content" maxlength="500" required placeholder="Vi·∫øt ƒë√°nh gi√° c·ªßa b·∫°n t·∫°i ƒë√¢y..." style="font-size:16px"></textarea>

                    <div class="star-rating">
                        <i class="fa fa-star" data-value="1"></i>
                        <i class="fa fa-star" data-value="2"></i>
                        <i class="fa fa-star" data-value="3"></i>
                        <i class="fa fa-star" data-value="4"></i>
                        <i class="fa fa-star" data-value="5"></i>
                    </div>
                </div>

                <p id="reviewMessage" style="display: none;"></p>
                <button type="button" onclick="submitReview()" class="btn-submit-review">G·ª≠i ƒë√°nh gi√°</button>
            </div>
            <div class="mt-4">
                <a class="report-toggle text-danger text-decoration-none" href="#" id="toggleReportForm" style="font-size: 20px;">
                    <i class="fas fa-flag"></i> B√°o c√°o b√†i ƒëƒÉng n·∫øu b·∫°n c·∫£m th·∫•y b√†i ƒëƒÉng mang t√≠nh ch·∫•t l·ª´a ƒë·∫£o
                </a>

                <div id="reportForm" class="report-section mt-3" style="display: none;">
                    <form asp-action="ReportHouse" asp-controller="Report" method="post">
                        <input type="hidden" name="houseId" value="@Model.IdHouse" />

                        <div class="mb-3">
                            <label for="Content" class="form-label fw-bold text-danger">
                                &nbsp;L√Ω do b√°o c√°o
                            </label>
                            <textarea id="Content" name="reason" class="form-control shadow-sm rounded-3"
                                    rows="5" maxlength="500" required
                                    placeholder="Vi·∫øt l√Ω do b√°o c√°o..." style="font-size: 16px;"></textarea>
                        </div>

                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-flag"></i> G·ª≠i B√°o C√°o
                        </button>
                    </form>
                </div>
            </div>
        }

        <label class="section-title">C√°c B√†i Vi·∫øt Kh√°c C·ªßa Ng∆∞·ªùi ƒêƒÉng @ViewBag.OwnerName</label>
        <div class="section-underline"></div>
        <div class="no-houses-message">
            @if (ViewBag.OtherHouses == null || !(ViewBag.OtherHouses as List<KLTN.Models.House>)?.Any() == true)
            {
                <p class="no-houses-message">Ch·ªß nh√† ch∆∞a c√≥ ph√≤ng tr·ªç kh√°c.</p>
            }
        </div> 
        <div class="slick-house-carousel">
            @if (ViewBag.OtherHouses != null && (ViewBag.OtherHouses as List<KLTN.Models.House>)?.Any() == true)
            {
                foreach (var otherHouse in ViewBag.OtherHouses as List<KLTN.Models.House>)
                {
                    var firstDetail = otherHouse.HouseDetails?.FirstOrDefault();
                    if (firstDetail != null)
                    {
                        var timePost = firstDetail.TimePost;

                        <div class="card me-2">
                            <a href="@Url.Action("Detail", "Home", new { id = otherHouse.IdHouse })" class="card-link">
                                <img src="@firstDetail.Image.Split(',')[0]" class="card-img-top" style="height: 160px; object-fit: cover;" />
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title"><strong>@otherHouse.NameHouse</strong></h5>
                                    <p class="card-text"><strong>Ng∆∞·ªùi ƒëƒÉng:</strong> <span>@ViewBag.OwnerName</span></p>
                                    <p class="card-text address-truncate"><strong>ƒê·ªãa ch·ªâ:</strong> @firstDetail.Address</p>
                                    <p class="card-text"><strong>Di·ªán t√≠ch:</strong> @firstDetail.DienTich m¬≤</p>
                                    <p class="card-text"><strong>Gi√°:</strong> 
                                        <span style="color: red">@firstDetail.Price.ToString("#,0", new System.Globalization.CultureInfo("vi-VN")) VND</span>
                                    </p>
                                    <p class="card-text"><strong>Lo·∫°i nh√† tr·ªç:</strong> @otherHouse.HouseType?.Name</p>
                                    <p class="card-text"><strong>Ng√†y ƒëƒÉng:</strong> @timePost.ToString("dd/MM/yyyy")</p>
                                    @* <a href="@Url.Action("Detail", "Home", new { id = otherHouse.IdHouse })" class="btn btn-sm btn-primary mt-auto">Xem Chi Ti·∫øt</a> *@
                                </div>
                            </a>
                        </div>
                    }
                }
            }
        </div>

        <label class="section-title">C√≥ Th·ªÉ B·∫°n Quan T√¢m</label>
        <div class="section-underline"></div>
        <div class="slick-house-carousel">
            @if (ViewBag.OtherHousesUser != null && (ViewBag.OtherHousesUser as List<KLTN.Models.House>)?.Any() == true)
            {
                foreach (var house in ViewBag.OtherHousesUser as List<KLTN.Models.House>)
                {
                    var firstDetail = house.HouseDetails?.FirstOrDefault();
                    if (firstDetail != null)
                    {
                        var timePost = firstDetail.TimePost;

                        <div class="card me-2">
                            <a href="@Url.Action("Detail", "Home", new { id = house.IdHouse })" class="card-link">
                                <img src="@firstDetail.Image.Split(',')[0]" class="card-img-top" style="height: 160px; object-fit: cover;" />
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title"><strong>@house.NameHouse</strong></h5>
                                    <p class="card-text"><strong>Ng∆∞·ªùi ƒëƒÉng:</strong> @house.IdUserNavigation?.UserName</p>
                                    <p class="card-text address-truncate"><strong>ƒê·ªãa ch·ªâ:</strong> @firstDetail.Address</p>
                                    <p class="card-text"><strong>Di·ªán t√≠ch:</strong> @firstDetail.DienTich m¬≤</p>
                                    <p class="card-text"><strong>Gi√°:</strong>
                                        <span style="color: red">@firstDetail.Price.ToString("#,0", new System.Globalization.CultureInfo("vi-VN")) VND</span>
                                    </p>
                                    <p class="card-text"><strong>Lo·∫°i nh√† tr·ªç:</strong> @house.HouseType?.Name</p>
                                    <p class="card-text"><strong>Ng√†y ƒëƒÉng:</strong> @timePost.ToString("dd/MM/yyyy")</p>
                                    @* <a href="@Url.Action("Detail", "Home", new { id = house.IdHouse })" class="btn btn-sm btn-primary mt-auto">Xem Chi Ti·∫øt</a> *@
                                </div>
                            </a>
                        </div>
                    }
                }
            }
            else
            {
                <p class="no-houses-message">Kh√¥ng c√≥ nh√† tr·ªç g·ª£i √Ω.</p>
            }
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.min.css" />
    <script src="~/js/goong-js.js"></script>
    <script src="~/js/House/detail.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const stars = document.querySelectorAll(".star-rating .fa-star");

            stars.forEach(star => {
                star.addEventListener("click", function () {
                    const value = parseInt(this.getAttribute("data-value"));
                    
                    // B·ªè ch·ªçn t·∫•t c·∫£ sao tr∆∞·ªõc khi ch·ªçn m·ªõi
                    stars.forEach(s => s.classList.remove("selected"));
                    
                    // Ch·ªçn l·∫°i ƒë√∫ng s·ªë sao
                    for (let i = 0; i < value; i++) {
                        stars[i].classList.add("selected");
                    }

                    // L∆∞u s·ªë sao v√†o data attribute
                    document.querySelector(".star-rating").setAttribute("data-selected", value);
                });
            });

            const toggleBtn = document.getElementById("toggleReportForm");
            const reportForm = document.getElementById("reportForm");

            toggleBtn.addEventListener("click", function (e) {
                e.preventDefault();

                if (reportForm.style.display === "none" || reportForm.style.display === "") {
                    reportForm.style.display = "block";
                } else {
                    reportForm.style.display = "none";
                }
            });
        });

        async function submitReview() {
            let isAuthenticated = document.getElementById("isAuthenticated").value === "true";

            if (!isAuthenticated) {
                const returnUrl = encodeURIComponent(window.location.pathname + window.location.search);
                window.location.href = `/Account/Login?returnUrl=${returnUrl}`;
            }

            // L·∫•y s·ªë sao ƒë∆∞·ª£c ch·ªçn
            const rating = parseInt(document.querySelector(".star-rating").getAttribute("data-selected")) || 0;
            const content = document.getElementById("Content").value.trim();

            if (rating === 0 || content === "") {
                iziToast.warning({
                    title: "C·∫£nh b√°o",
                    message: "Vui l√≤ng ch·ªçn s·ªë sao v√† nh·∫≠p n·ªôi dung ƒë√°nh gi√°.",
                    position: "topRight",
                    timeout: 1500,
                });
                return; 
            }

            const houseId = document.querySelector(".review-form").dataset.houseId;
            if (!houseId) {
                iziToast.error({
                    title: "L·ªói",
                    message: "Kh√¥ng t√¨m th·∫•y IdHouse. Vui l√≤ng th·ª≠ l·∫°i.",
                    position: "topRight",
                });
                return;
            }

            const reviewData = { Rating: rating, Content: content };

            try {
                const response = await fetch(`/Detail/AddReview/${houseId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(reviewData),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    iziToast.success({
                        title: "Th√†nh c√¥ng",
                        message: result.message,
                        position: "topRight",
                        timeout: 1500,
                    });

                    // ·∫®n th√¥ng b√°o "Ch∆∞a c√≥ ƒë√°nh gi√° n√†o" n·∫øu c√≥
                    const noReviewMessage = document.querySelector(".review-section p");
                    if (noReviewMessage) noReviewMessage.style.display = "none";

                    // Th√™m ƒë√°nh gi√° m·ªõi v√†o danh s√°ch
                    const reviewList = document.querySelector(".review-list") || document.createElement("ul");
                    reviewList.classList.add("review-list");

                    const newReview = document.createElement("li");
                    newReview.classList.add("review-item");

                    newReview.innerHTML = `
                        <div class="review-header">
                            <strong class="review-username">${result.review.UserName}</strong>
                            <span class="review-date">${result.review.ReviewDate}</span>
                            <span class="review-rating">Rating: ${result.review.Rating} ‚òÖ</span>
                        </div>
                        <p class="review-content">${result.review.Content}</p>
                    `;

                    reviewList.appendChild(newReview);

                    if (!document.querySelector(".review-list")) {
                        document.querySelector(".review-section").appendChild(reviewList);
                    }

                    // X√≥a n·ªôi dung form sau khi g·ª≠i ƒë√°nh gi√°
                    document.getElementById("Content").value = "";
                    document.querySelectorAll(".star-rating .fa-star").forEach(star => star.classList.remove("selected"));
                } else {
                    iziToast.error({
                        title: "L·ªói",
                        message: result.message || "ƒê√£ x·∫£y ra l·ªói khi g·ª≠i ƒë√°nh gi√°.",
                        position: "topRight",
                        timeout: 1500,
                    });
                }
            } catch (error) { 
                iziToast.error({
                    title: "L·ªói",
                    message: "ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.",
                    position: "topRight",
                    timeout: 1500,
                });
            }
        }

        function handleChatClick() {
            const isAuthenticated = document.getElementById("isAuthenticated").value === "true";

            if (!isAuthenticated) {
                // L∆∞u ƒë∆∞·ªùng d·∫´n hi·ªán t·∫°i k√®m theo query m·ªü chat
                const currentUrl = window.location.pathname + window.location.search;
                const returnUrl = encodeURIComponent(currentUrl);
                window.location.href = `/Account/Login?returnUrl=${returnUrl}`;
            } else {
                // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p th√¨ ƒëi t·ªõi trang chat 
                const conversationId = "@ViewBag.ConversationId";
                window.location.href = `/Chat/ChatList?conversationId=${conversationId}`;
            }
        }
        
        // S·ª≠ d·ª•ng API key cho c√°c ch·ª©c nƒÉng geocode, autocomplete, v.v.
        async function setInitialAddress() {
            var addressFromModel = document.getElementById("house-address").dataset.address;
            var decodedAddress = new DOMParser().parseFromString(addressFromModel, "text/html").body.textContent;
                console.log("ƒê·ªãa ch·ªâ gi·∫£i m√£:", decodedAddress);

            if (decodedAddress) {
                try {
                // G·ªçi API Geocode v·ªõi API key
                const response = await fetch(
                    `https://rsapi.goong.io/Geocode?address=${encodeURIComponent(
                    decodedAddress
                    )}&api_key=RJ9d6oO2TLx8s4Q8riMgne1hI905XhC89HxJ7fIy`
                );
                const data = await response.json();
                console.log("K·∫øt qu·∫£ t·ª´ API Goong:", data);

                if (data.results.length > 0) {
                    const { geometry, formatted_address } = data.results[0];
                    const lat = geometry.location.lat;
                    const lng = geometry.location.lng;

                    console.log("D·ªØ li·ªáu t·ª´ API Goong:", data);
                    console.log("ƒê·ªãa ch·ªâ:", formatted_address);
                    console.log("Latitude:", lat);
                    console.log("Longitude:", lng);
                    document.getElementById("Latitude").value = lat;
                    document.getElementById("Longitude").value = lng;

                    fetch('/House/SaveLatLng', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify({
                        houseId: @Model.IdHouse,
                        lat: lat,
                        lng: lng
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log("ƒê√£ l∆∞u lat/lng v√†o HouseDetail");
                    } else {
                        console.error("L·ªói:", data.message);
                    }
                })
                .catch(error => {
                    console.error("L·ªói fetch:", error);
                });

                map.setCenter([geometry.location.lng, geometry.location.lat]);
                    var marker = new goongjs.Marker({ color: "red" })
                    .setLngLat([geometry.location.lng, geometry.location.lat])
                    .addTo(map)
                    .setPopup(
                        new goongjs.Popup().setHTML(
                        `<strong>ƒê·ªãa ch·ªâ:</strong> ${formatted_address}`
                        )
                    )
                    .togglePopup();
                    } else {
                        alert("Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ.");
                    }
                } catch (error) {
                    console.error("L·ªói khi g·ªçi API Geocode:", error);
                }
            } else {
                console.warn("ƒê·ªãa ch·ªâ kh√¥ng h·ª£p l·ªá.");
            }
        }

        setInitialAddress();

        // T·ª± th√™m ƒë·ªãa ch·ªâ v√†o form h·∫πn 
        const addressFromRazor = "@Html.Raw(Model.HouseDetails.FirstOrDefault()?.Address)";
        // S·ª± ki·ªán m·ªü form
        document.getElementById("bookAppointmentBtn")?.addEventListener("click", function () {
            document.getElementById("appointmentOverlay").style.display = "block";
            document.getElementById("appointmentForm").style.display = "block";

            // G√°n ƒë·ªãa ch·ªâ v√†o input
            document.getElementById("appointmentLocation").value = addressFromRazor || "Kh√¥ng c√≥ ƒë·ªãa ch·ªâ";
        });

        // ƒê√≥ng form
        document.getElementById("closeForm")?.addEventListener("click", function () {
            document.getElementById("appointmentOverlay").style.display = "none";
            document.getElementById("appointmentForm").style.display = "none";
        });
   
        // Carousel cho b√†i ƒëƒÉng kh√°c c·ªßa ch·ªß tr·ªç v√† c√≥ th·ªÉ b·∫°n quan t√¢m
        $('.slick-house-carousel').slick({
            slidesToShow: 4,
            slidesToScroll: 1,
            arrows: true,
            prevArrow: '<button type="button" class="slick-custom-prev"><i class="fas fa-chevron-left"></i></button>',
            nextArrow: '<button type="button" class="slick-custom-next"><i class="fas fa-chevron-right"></i></button>',
            responsive: [
                {
                    breakpoint: 1200,
                    settings: {
                        slidesToShow: 3
                    }
                },
                {
                    breakpoint: 992,
                    settings: {
                        slidesToShow: 2
                    }
                },
                {
                    breakpoint: 768,
                    settings: {
                        slidesToShow: 1
                    }
                }
            ]
        });
    </script>
</body>