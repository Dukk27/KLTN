@model KLTN.Models.Account

@{
    ViewData["Title"] = "Chỉnh sửa thông tin tài khoản";
    ViewData["ShowSidebar"] = !User.IsInRole("Admin");
}

<head>
    <link rel="stylesheet" href="~/css/iziToast.css">
    <link rel="stylesheet" href="~/css/Account/edit.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/sidebar.css" asp-append-version="true" />
    <script src="~/js/eye.js"></script>
</head>

<body>
    <div class="login-wrapper">
        <div class="login-illustration">
            <img src="~/img/login.jpg" alt="Login Illustration" />
        </div>

        <div class="login-form-container">
            <h1 class="login-title">Chỉnh sửa thông tin tài khoản</h1>

            <form asp-action="Edit" method="post" class="account-form">
                <input type="hidden" asp-for="IdUser" />

                <div class="form-group">
                    <label for="UserName" class="form-label">Tên đăng nhập</label>
                    <input type="text" class="form-control" id="UserName" name="UserName" value="@Model.UserName" required />
                </div>

                <div class="form-group">
                    <label for="PhoneNumber" class="form-label">Số điện thoại</label>
                    <input type="text" class="form-control" id="PhoneNumber" name="PhoneNumber" value="@Model.PhoneNumber" />
                </div>

                <div class="form-group">
                    <label for="Email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="Email" name="Email" value="@Model.Email" />
                </div>

                <div class="form-group"> 
                    <label for="Password" class="form-label">Mật khẩu</label>
                    <input type="password" class="form-control" id="Password" name="Password" value="@Model.Password" hidden />
                    <button type="button" class="btn btn-warning btn-change-password" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                        Thay đổi mật khẩu?
                    </button>
                </div>

                <div class="form-group">
                    <label for="Role" class="form-label">Vai trò</label>
                    <input type="text" class="form-control text-muted" id="RoleDisplay" value="@(Model.Role == 0 ? "Admin" : Model.Role == 1 ? "Chủ trọ" : "Người tìm thuê")" readonly />
                    <input type="hidden" id="Role" name="Role" value="@Model.Role" />
                </div>

                <div class="button-container">
                    <button type="button" class="btnclose" onclick="handleClose()">Huỷ</button>
                    <button type="submit" class="btn btn-primary">Cập nhật</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal đổi mật khẩu -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="changePasswordForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="changePasswordModalLabel" style="font-weight: bold">Đổi mật khẩu</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="OldPassword" class="form-label">Mật khẩu cũ</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="OldPassword" name="currentPassword" required>
                                <button type="button" class="btn btn-outline-secondary toggle-password" data-target="OldPassword">
                                    <i class="fa-regular fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="NewPassword" class="form-label">Mật khẩu mới</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="NewPassword" name="newPassword" required>
                                <button type="button" class="btn btn-outline-secondary toggle-password" data-target="NewPassword">
                                    <i class="fa-regular fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="ConfirmPassword" class="form-label">Xác nhận mật khẩu mới</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="ConfirmPassword" name="confirmPassword" required>
                                <button type="button" class="btn btn-outline-secondary toggle-password" data-target="ConfirmPassword">
                                    <i class="fa-regular fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btnclose" data-bs-dismiss="modal" style="background-color: #EBEDF4">Đóng</button>
                        <button type="submit" class="btn btn-primary">Cập nhật</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Thêm iziToast -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelector(".account-form").addEventListener("submit", function (event) {
                event.preventDefault();

                let form = this;
                let formData = new FormData(form);

                iziToast.question({
                    timeout: 20000,
                    close: false, 
                    overlay: true,
                    displayMode: 'once',
                    id: 'question',
                    zindex: 999,
                    title: 'Xác nhận cập nhật',
                    message: 'Bạn có chắc chắn muốn cập nhật thông tin không?',
                    position: 'center',
                    class: 'iziToast-custom', /* Áp dụng class mới */
                    buttons: [
                        ['<button><i class="fa fa-check"></i>Có, cập nhật</button>', function (instance, toast) {
                            instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');

                            fetch(form.action, {
                                method: "POST",
                                body: formData
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        // Cập nhật tên ngay sau khi đổi
                                        document.getElementById("headerUserName").innerText = data.updatedData.userName;
                                        
                                        iziToast.success({
                                            title: 'Thành công!',
                                            message: 'Thông tin tài khoản đã được cập nhật.',
                                            position: 'topRight',
                                            timeout: 1500,
                                        });

                                        document.querySelector(".breadcrumb-item.active").innerHTML =
                                            `Chỉnh Sửa Thông Tin Tài Khoản ${data.updatedData.userName}`;
                                        document.querySelector("#UserName").value = data.updatedData.userName;
                                        document.querySelector("#PhoneNumber").value = data.updatedData.phoneNumber;
                                        document.querySelector("#Email").value = data.updatedData.email;
                                        document.getElementById("headerUserName").innerText = data.updatedData.userName;

                                    } else {
                                        iziToast.error({
                                            title: 'Thất bại!',
                                            message: data.message,
                                            position: 'topRight',
                                            timeout: 1500,
                                        });
                                    }
                                })
                                @* .catch(error => {
                                    iziToast.error({
                                        title: 'Lỗi hệ thống!',
                                        message: 'Không thể gửi yêu cầu, kiểm tra kết nối.',
                                        position: 'topRight',
                                        color: 'red',
                                        timeout: 1500
                                    });
                                }); *@

                        }, true],

                        ['<button><i class="fa fa-times"></i> Hủy</button>', function (instance, toast) {
                            instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                        }]
                    ]
                });
            });
        });

        function handleClose() {
            let role = @Model.Role; // Lấy vai trò của người dùng từ Model
            if (role === 0) {
                window.location.href = '@Url.Action("Index", "Admin")'; // Chuyển hướng về trang Admin
            } else {
                window.location.href = '@Url.Action("Index", "Home")'; // Chuyển hướng về trang chủ
            }
        }
    
        $('#changePasswordModal').on('show.bs.modal', function () {
            // Lấy tất cả các input trong modal và xóa giá trị của chúng
            $('#OldPassword').val('');
            $('#NewPassword').val('');
            $('#ConfirmPassword').val('');
        });

        document.getElementById("changePasswordForm").addEventListener("submit", function (event) {
            event.preventDefault();

            var formData = new FormData(this);

            iziToast.question({
                timeout: 20000,
                close: false,
                overlay: true,
                displayMode: 'once',
                id: 'question',
                zindex: 9999,
                title: 'Xác nhận đổi mật khẩu',
                message: 'Bạn có chắc chắn muốn thay đổi mật khẩu không?',
                position: 'center',
                class: 'iziToast-custom', /* Áp dụng CSS tùy chỉnh */
                buttons: [
                    ['<button><i class="fa fa-check"></i>Đồng ý</button>', function (instance, toast) {
                        instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');

                        fetch('@Url.Action("ChangePassword", "Account")', {
                            method: "POST",
                            body: formData
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    iziToast.success({
                                        title: 'Thành công!',
                                        message: 'Mật khẩu của bạn đã được thay đổi.',
                                        position: 'topRight',
                                        timeout: 1500
                                    });
                                    $('#changePasswordModal').modal('hide');
                                } else {
                                    iziToast.error({
                                        title: 'Lỗi!',
                                        message: data.message || 'Đổi mật khẩu không thành công!',
                                        position: 'topRight',
                                        timeout: 1500
                                    });
                                }
                            })
                            .catch(error => {
                                iziToast.error({
                                    title: 'Lỗi hệ thống!',
                                    message: 'Vui lòng thử lại sau.',
                                    position: 'topRight',
                                    color: 'red',
                                    timeout: 1500
                                });
                            });

                    }, true],

                    ['<button><i class="fa fa-times"></i> Hủy</button>', function (instance, toast) {
                            instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                    }]
                ]
            });
        });
    </script>
</body>