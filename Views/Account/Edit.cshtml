@model KLTN.Models.Account

@{
    ViewData["Title"] = "Ch·ªânh s·ª≠a th√¥ng tin t√†i kho·∫£n";
}

<link rel="stylesheet" href="~/css/iziToast.css">
<link rel="stylesheet" href="~/css/Account/edit.css" asp-append-version="true" />

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Trang Ch·ªß</a></li>
        <li class="breadcrumb-item active" aria-current="page">Ch·ªânh S·ª≠a Th√¥ng Tin T√†i Kho·∫£n @Model.UserName</li>
    </ol>
</nav>

<h2 class="page-title">Ch·ªânh s·ª≠a th√¥ng tin t√†i kho·∫£n</h2>

<form asp-action="Edit" method="post" class="account-form">
    <input type="hidden" asp-for="IdUser" />

    <div class="form-group">
        <label for="UserName" class="form-label">T√™n ƒëƒÉng nh·∫≠p</label>
        <input type="text" class="form-control" id="UserName" name="UserName" value="@Model.UserName" required />
    </div>

    <div class="form-group">
        <label for="PhoneNumber" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
        <input type="text" class="form-control" id="PhoneNumber" name="PhoneNumber" value="@Model.PhoneNumber" />
    </div>

    <div class="form-group">
        <label for="Email" class="form-label">Email</label>
        <input type="email" class="form-control" id="Email" name="Email" value="@Model.Email" />
    </div>

    <div class="form-group">
        <label for="Password" class="form-label">M·∫≠t kh·∫©u</label>
        <input type="password" class="form-control" id="Password" name="Password" value="@Model.Password" hidden />

        <button type="button" class="btn btn-warning btn-change-password"
            onclick="window.location.href='@Url.Action("ChangePassword", "Account")'">
            ƒê·ªïi m·∫≠t kh·∫©u
        </button>
    </div>

    <div class="form-group">
        <label for="Role" class="form-label">Vai tr√≤</label>
        <input type="text" class="form-control" id="RoleDisplay"
            value="@(Model.Role == 0 ? "Admin" : Model.Role == 1 ? "Ch·ªß tr·ªç" : "Ng∆∞·ªùi t√¨m thu√™")" readonly />

        <!-- Input ·∫©n ƒë·ªÉ gi·ªØ gi√° tr·ªã th·ª±c c·ªßa Role khi g·ª≠i form -->
        <input type="hidden" id="Role" name="Role" value="@Model.Role" />
    </div>

    <div class="form-group" hidden>
        <label for="FreePostUsed" class="form-label">S·ªë b√†i ƒëƒÉng free ƒë√£ d√πng</label>
        <input type="text" class="form-control" id="FreePostsUsed" name="FreePostsUsed" value="@Model.FreePostsUsed"
            readonly />
    </div>

    <div class="button-container">
        <button type="button" class="btn btn-secondary" onclick="handleClose()">ƒê√≥ng</button>
        <button type="submit" class="btn btn-primary">C·∫≠p nh·∫≠t</button>
    </div>
</form>

<!-- Th√™m iziToast -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelector(".account-form").addEventListener("submit", function (event) {
            event.preventDefault();

            let form = this;
            let formData = new FormData(form);

            iziToast.question({
                timeout: 20000,
                close: false,
                overlay: true,
                displayMode: 'once',
                id: 'question',
                zindex: 999,
                title: 'üîî X√°c nh·∫≠n c·∫≠p nh·∫≠t',
                message: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën c·∫≠p nh·∫≠t th√¥ng tin kh√¥ng?',
                position: 'center',
                class: 'iziToast-custom', /* √Åp d·ª•ng class m·ªõi */
                buttons: [
                    ['<button><i class="fa fa-check"></i>C√≥, c·∫≠p nh·∫≠t</button>', function (instance, toast) {
                        instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');

                        fetch(form.action, {
                            method: "POST",
                            body: formData
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    iziToast.success({
                                        title: 'Th√†nh c√¥ng!',
                                        message: 'Th√¥ng tin t√†i kho·∫£n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.',
                                        position: 'topRight',
                                        timeout: 1500,
                                    });

                                    document.querySelector(".breadcrumb-item.active").innerHTML =
                                        `Ch·ªânh S·ª≠a Th√¥ng Tin T√†i Kho·∫£n ${data.updatedData.userName}`;
                                    document.querySelector("#UserName").value = data.updatedData.userName;
                                    document.querySelector("#PhoneNumber").value = data.updatedData.phoneNumber;
                                    document.querySelector("#Email").value = data.updatedData.email;
                                    document.getElementById("headerUserName").innerText = data.updatedData.userName;

                                } else {
                                    iziToast.error({
                                        title: 'Th·∫•t b·∫°i!',
                                        message: data.message,
                                        position: 'topRight'
                                    });
                                }
                            })
                            .catch(error => {
                                iziToast.error({
                                    title: 'L·ªói h·ªá th·ªëng!',
                                    message: 'Kh√¥ng th·ªÉ g·ª≠i y√™u c·∫ßu, ki·ªÉm tra k·∫øt n·ªëi.',
                                    position: 'topRight'
                                });
                            });

                    }, true],

                    ['<button><i class="fa fa-times"></i> H·ªßy</button>', function (instance, toast) {
                        instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                        iziToast.info({
                            title: 'Th√¥ng b√°o',
                            message: 'B·∫°n ƒë√£ h·ªßy c·∫≠p nh·∫≠t.',
                            position: 'topRight'
                        });
                    }]
                ]
            });
        });
    });

    function handleClose() {
        let role = @Model.Role; // L·∫•y vai tr√≤ c·ªßa ng∆∞·ªùi d√πng t·ª´ Model
        if (role === 0) {
            window.location.href = '@Url.Action("Index", "Admin")'; // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang Admin
        } else {
            window.location.href = '@Url.Action("Index", "Home")'; // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß
        }
    }
</script>
