@model IEnumerable<KLTN.Models.House>

<link rel="stylesheet" href="~/css/iziToast.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<h3 class="text-center mt-3">Qu·∫£n l√Ω b√†i ƒëƒÉng</h3>

<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>T√™n nh√† tr·ªç</th>
            <th>ƒê·ªãa ch·ªâ</th>
            <th>Gi√°</th>
            <th>Ng∆∞·ªùi ƒëƒÉng</th>
            <th>Tr·∫°ng th√°i</th>
            <th>H√†nh ƒë·ªông</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var house in Model)
        {
            @if (house.Status == HouseStatus.Unpaid)
        {
            continue; // B·ªè qua b√†i ch∆∞a thanh to√°n
        }
            <tr>
                <td>@house.IdHouse</td>
                <td>@house.NameHouse</td>
                <td>@house.HouseDetails.FirstOrDefault()?.Address</td>
                <td>@house.HouseDetails.FirstOrDefault()?.Price.ToString("#,0", new System.Globalization.CultureInfo("vi-VN")) VND</td>
                <td>@house.IdUserNavigation.UserName</td>
                <td>
                    @if (house.Status == HouseStatus.Pending)
                    {
                        <span class="badge bg-warning text-dark">Ch·ªù duy·ªát</span>
                    }
                    else if (house.Status == HouseStatus.Approved || house.Status == HouseStatus.Active || house.Status == HouseStatus.Hidden )
                    {
                        <span class="badge bg-success">ƒê√£ duy·ªát</span>
                    }
                    else
                    {
                        <span class="badge bg-danger">B·ªã t·ª´ ch·ªëi</span>
                    }
                </td>
                <td>       
                    <button class="btn btn-sm btn-primary btn-view-detail" onclick="viewDetail(@house.IdHouse, 'house')" title="Xem chi ti·∫øt b√†i ƒëƒÉng"><i class="fas fa-eye"></i></button>          
   
                    <button class="btn btn-sm btn-danger delete-house" data-id="@house.IdHouse" title="Xo√° b√†i ƒëƒÉng"><i class="fas fa-trash-alt"></i></button>
                    
                    @if (house.Status == HouseStatus.Pending || house.Status == HouseStatus.Rejected)
                    {
                        <button class="btn btn-sm btn-success approve-house" data-id="@house.IdHouse"><i class="fas fa-check"></i> Duy·ªát</button>
                    }

                    @if (house.Status == HouseStatus.Approved || house.Status == HouseStatus.Active || house.Status == HouseStatus.Hidden)
                    {
                        <button class="btn btn-sm btn-danger reject-house" data-id="@house.IdHouse"><i class="fas fa-times"></i> T·ª´ ch·ªëi</button>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Th√™m th∆∞ vi·ªán iziToast -->
<script src="https://cdn.jsdelivr.net/npm/izitoast/dist/js/iziToast.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast/dist/css/iziToast.min.css">

<script>
    function viewDetail(id, type) {
            const url = `/Home/Detail?id=${id}&type=${type}`;
            fetch(url, { method: 'GET' })
                .then(response => {
                    if (response.ok) {
                        window.location.href = url;
                    } else {
                        iziToast.error({
                            title: "L·ªói!",
                            message: "Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt. Vui l√≤ng th·ª≠ l·∫°i.",
                            position: "topRight"
                        });
                    }
                })
                .catch(() => {
                    iziToast.error({
                        title: "L·ªói!",
                        message: "ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω y√™u c·∫ßu.",
                        position: "topRight"
                    });
                });
        }

    $(document).ready(function () {
        
        // X√≥a b√†i ƒëƒÉng
        $(document).on("click", ".delete-house", function () {
            const id = $(this).data("id");

            iziToast.show({
                class: "iziToast-custom",
                title: "üîî X√°c nh·∫≠n x√≥a",
                message: "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i ƒëƒÉng n√†y?",
                position: "center",
                timeout: false,
                close: false,
                overlay: true,
                buttons: [
                    [
                        '<button><i class="fa fa-check"></i> X√≥a</button>',
                        function (instance, toast) {
                            instance.hide({ transitionOut: "fadeOut" }, toast, "button");

                            $.post("@Url.Action("DeletePost", "Admin")", { id: id }, function (response) {
                                iziToast.show({
                                    title: response.success ? "‚úÖ Th√†nh c√¥ng!" : "‚ùå L·ªói!",
                                    message: response.message,
                                    position: "topRight",
                                    color: response.success ? "green" : "red",
                                    timeout: 1000
                                });

                                if (response.success) {
                                    $(`tr:has(button[data-id='${id}'])`).remove();
                                }
                            }).fail(() => {
                                iziToast.error({
                                    title: "L·ªói!",
                                    message: "ƒê√£ x·∫£y ra l·ªói khi x√≥a b√†i ƒëƒÉng.",
                                    position: "topRight"
                                });
                            });
                        },
                        true
                    ],
                    [
                        '<button><i class="fa fa-times"></i> H·ªßy</button>',
                        function (instance, toast) {
                            instance.hide({ transitionOut: "fadeOut" }, toast, "button");
                        }
                    ]
                ]
            });
        });

        let isToastVisible = false;

        // X√≥a s·ª± ki·ªán c≈© tr∆∞·ªõc khi g√°n m·ªõi
        $(document).off("click", ".approve-house").on("click", ".approve-house", function () {
            if (isToastVisible) return; // N·∫øu ƒëang hi·ªÉn th·ªã th√¨ kh√¥ng m·ªü th√™m
            isToastVisible = true;

            const id = $(this).data("id");

            iziToast.show({
                class: "iziToast-custom",
                title: "üîî X√°c nh·∫≠n duy·ªát",
                message: "B·∫°n c√≥ ch·∫Øc mu·ªën duy·ªát b√†i ƒëƒÉng n√†y?",
                position: "center",
                timeout: false,
                close: false,
                overlay: true,
                onClosing: function() { // Khi iziToast b·ªã ƒë√≥ng, ƒë·∫∑t l·∫°i bi·∫øn
                    isToastVisible = false;
                },
                buttons: [
                    [
                        '<button><i class="fa fa-check"></i> Duy·ªát</button>',
                        function (instance, toast) {
                            isToastVisible = false; // ƒê·∫∑t l·∫°i tr·∫°ng th√°i ƒë·ªÉ cho ph√©p hi·ªÉn th·ªã l·∫ßn sau
                            instance.hide({ transitionOut: "fadeOut" }, toast, "button");

                            $.post("@Url.Action("ApprovePost", "Admin")", { id: id }, function (response) {
                                iziToast.show({
                                    title: response.success ? "‚úÖ Th√†nh c√¥ng!" : "‚ùå L·ªói!",
                                    message: response.message,
                                    position: "topRight",
                                    color: response.success ? "green" : "red",
                                    timeout: 1000
                                });

                                if (response.success) {
                                    updateStatus(id, "ƒê√£ duy·ªát", "bg-success");
                                    toggleButtons(id, "reject");
                                }
                            }).fail(() => {
                                iziToast.error({
                                    title: "L·ªói!",
                                    message: "ƒê√£ x·∫£y ra l·ªói khi duy·ªát b√†i ƒëƒÉng.",
                                    position: "topRight"
                                });
                            });
                        },
                        true
                    ],
                    [
                        '<button><i class="fa fa-times"></i> H·ªßy</button>',
                        function (instance, toast) {
                            isToastVisible = false; // ƒê·∫∑t l·∫°i tr·∫°ng th√°i ƒë·ªÉ cho ph√©p hi·ªÉn th·ªã l·∫ßn sau
                            instance.hide({ transitionOut: "fadeOut" }, toast, "button");
                        }
                    ]
                ]
            });
        });

        $(document).off("click", ".reject-house").on("click", ".reject-house", function () {
            if (isToastVisible) return; // N·∫øu ƒëang hi·ªÉn th·ªã th√¨ kh√¥ng m·ªü th√™m
            isToastVisible = true;

            const id = $(this).data("id");

            iziToast.show({
                class: "iziToast-custom",
                title: "üîî X√°c nh·∫≠n t·ª´ ch·ªëi",
                message: "B·∫°n c√≥ ch·∫Øc mu·ªën t·ª´ ch·ªëi b√†i ƒëƒÉng n√†y?",
                position: "center",
                timeout: false,
                close: false,
                overlay: true,
                onClosing: function() { // Khi iziToast b·ªã ƒë√≥ng, ƒë·∫∑t l·∫°i bi·∫øn
                    isToastVisible = false;
                },
                buttons: [
                    [
                        '<button><i class="fa fa-times"></i> T·ª´ ch·ªëi</button>',
                        function (instance, toast) {
                            isToastVisible = false; // ƒê·∫∑t l·∫°i tr·∫°ng th√°i ƒë·ªÉ cho ph√©p hi·ªÉn th·ªã l·∫ßn sau
                            instance.hide({ transitionOut: "fadeOut" }, toast, "button");

                            $.post("@Url.Action("RejectPost", "Admin")", { id: id }, function (response) {
                                iziToast.show({
                                    title: response.success ? "‚úÖ Th√†nh c√¥ng!" : "‚ùå L·ªói!",
                                    message: response.message,
                                    position: "topRight",
                                    color: response.success ? "green" : "red",
                                    timeout: 1000
                                });

                                if (response.success) {
                                    updateStatus(id, "B·ªã t·ª´ ch·ªëi", "bg-danger");
                                    toggleButtons(id, "approve");
                                }
                            }).fail(() => {
                                iziToast.error({
                                    title: "L·ªói!",
                                    message: "ƒê√£ x·∫£y ra l·ªói khi t·ª´ ch·ªëi b√†i ƒëƒÉng.",
                                    position: "topRight"
                                });
                            });
                        },
                        true
                    ],
                    [
                        '<button><i class="fa fa-times"></i> H·ªßy</button>',
                        function (instance, toast) {
                            isToastVisible = false; // ƒê·∫∑t l·∫°i tr·∫°ng th√°i ƒë·ªÉ cho ph√©p hi·ªÉn th·ªã l·∫ßn sau
                            instance.hide({ transitionOut: "fadeOut" }, toast, "button");
                        }
                    ]
                ]
            });
        });

        // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i tr√™n giao di·ªán
        function updateStatus(id, statusText, statusClass) {
            const statusCell = $(`tr:has(button[data-id='${id}']) td:nth-child(6)`);
            statusCell.html(`<span class="badge ${statusClass}">${statusText}</span>`);
        }

        // H√†m ƒë·ªïi n√∫t duy·ªát, t·ª´ ch·ªëi
        function toggleButtons(id, action) {
            const actionCell = $(`tr:has(button[data-id='${id}']) td:last-child`);
            if (action === "reject") {
                actionCell.find(".approve-house").replaceWith(
                    `<button class="btn btn-sm btn-danger reject-house" data-id="${id}">
                        <i class="fas fa-times"></i> T·ª´ ch·ªëi
                    </button>`
                );
            } else {
                actionCell.find(".reject-house").replaceWith(
                    `<button class="btn btn-sm btn-success approve-house" data-id="${id}">
                        <i class="fas fa-check"></i> Duy·ªát
                    </button>`
                );
            }
        }
    });
</script>

<style>
    td:last-child {
        white-space: nowrap; /* NgƒÉn xu·ªëng d√≤ng */
        text-align: center; /* CƒÉn gi·ªØa n·ªôi dung */
    }

    td:last-child .btn {
        margin: 2px; /* T·∫°o kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
    }

    td:last-child {
        display: flex;
        justify-content: center;
        gap: 5px; /* Kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
        flex-wrap: wrap; /* Cho ph√©p xu·ªëng d√≤ng n·∫øu c·∫ßn */
    }

</style>