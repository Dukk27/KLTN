@model IEnumerable<KLTN.Models.House>

<head>
    <link rel="stylesheet" href="~/css/iziToast.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="~/css/Admin/account.css">
    <style>
        th {
            white-space: nowrap; /* NgƒÉn vi·ªác xu·ªëng d√≤ng trong ti√™u ƒë·ªÅ */
            text-align: center; /* CƒÉn gi·ªØa c√°c ti√™u ƒë·ªÅ */
        }

        td:last-child {
            white-space: nowrap; /* NgƒÉn xu·ªëng d√≤ng */
            text-align: center; /* CƒÉn gi·ªØa n·ªôi dung */
        }

        td:last-child .btn {
            margin: 2px; /* T·∫°o kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
        }

        td:last-child {
            display: flex;
            justify-content: center;
            gap: 5px; /* Kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
            flex-wrap: wrap; /* Cho ph√©p xu·ªëng d√≤ng n·∫øu c·∫ßn */
        }
    </style>
</head>

<body>
    <h3 class="text-center mt-3">Qu·∫£n l√Ω b√†i ƒëƒÉng</h3>

    <div class="row mb-3">
        <div class="col-12 col-md-4">
            <input type="text" id="searchInput" class="form-control" placeholder="üîç T√¨m ki·∫øm b√†i ƒëƒÉng..">
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>T√™n nh√† tr·ªç</th>
                    <th>ƒê·ªãa ch·ªâ</th>
                    <th>Gi√°</th>
                    <th>Ng∆∞·ªùi ƒëƒÉng</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var house in Model)
                {
                    @if (house.Status == HouseStatus.Unpaid)
                    {
                        continue; // B·ªè qua b√†i ch∆∞a thanh to√°n
                    }
                    <tr>
                        <td>@house.IdHouse</td>
                        <td>@house.NameHouse</td>
                        <td>@house.HouseDetails.FirstOrDefault()?.Address</td>
                        <td>@house.HouseDetails.FirstOrDefault()?.Price.ToString("#,0", new System.Globalization.CultureInfo("vi-VN")) VND</td>
                        <td>@house.IdUserNavigation.UserName</td>
                        <td>
                            @if (house.Status == HouseStatus.Pending)
                            {
                                <span class="badge bg-warning text-dark">Ch·ªù duy·ªát</span>
                            }
                            else if (house.Status == HouseStatus.Approved || house.Status == HouseStatus.Active || house.Status == HouseStatus.Hidden )
                            {
                                <span class="badge bg-success">ƒê√£ duy·ªát</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">B·ªã t·ª´ ch·ªëi</span>
                            }
                        </td>
                        <td>      
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary btn-view-detail" onclick="viewDetail(@house.IdHouse, 'house')" title="Xem chi ti·∫øt b√†i ƒëƒÉng"><i class="fas fa-eye"></i></button>          
            
                                @* <button class="btn btn-sm btn-danger delete-house" data-id="@house.IdHouse" title="Xo√° b√†i ƒëƒÉng"><i class="fas fa-trash-alt"></i></button> *@
                                
                                @if (house.Status == HouseStatus.Pending || house.Status == HouseStatus.Rejected)
                                {
                                    <button class="btn btn-sm btn-success approve-house" data-id="@house.IdHouse"><i class="fas fa-check"></i> Duy·ªát</button>
                                }

                                @if (house.Status == HouseStatus.Approved || house.Status == HouseStatus.Active || house.Status == HouseStatus.Hidden || house.Status == HouseStatus.Pending)
                                {
                                    <button class="btn btn-sm btn-danger reject-house" data-id="@house.IdHouse"><i class="fas fa-times"></i> T·ª´ ch·ªëi</button>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <!-- Th√™m th∆∞ vi·ªán iziToast -->
    <script src="https://cdn.jsdelivr.net/npm/izitoast/dist/js/iziToast.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast/dist/css/iziToast.min.css">

    <script>
        function viewDetail(id, type) {
            const url = `/Home/Detail?id=${id}&type=${type}`;
            fetch(url, { method: 'GET' })
                .then(response => {
                    if (response.ok) {
                        window.location.href = url;
                    } else {
                        iziToast.error({
                            title: "L·ªói!",
                            message: "Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt. Vui l√≤ng th·ª≠ l·∫°i.",
                            position: "topRight"
                        });
                    }
                })
                .catch(() => {
                    iziToast.error({
                        title: "L·ªói!",
                        message: "ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω y√™u c·∫ßu.",
                        position: "topRight"
                    });
                });
            }

        $(document).ready(function () {
            let isToastVisible = false;

            $(document).off("click", ".approve-house").on("click", ".approve-house", function () {
                if (isToastVisible) return; // N·∫øu ƒëang hi·ªÉn th·ªã th√¨ kh√¥ng m·ªü th√™m
                isToastVisible = true;

                const id = $(this).data("id");

                /* // Ki·ªÉm tra ƒëi·ªÅu ki·ªán b√†i ƒëƒÉng
                $.post("/Admin/ApprovePost", { id: id }, function (response) {
                    if (response.success === false) {
                        iziToast.error({
                            title: "L·ªói!",
                            message: "B√†i ƒëƒÉng ƒëang thi·∫øu: <br/>" + response.message,
                            position: "topRight",
                            timeout: 5000
                        });
                        isToastVisible = false; // ƒê·∫∑t l·∫°i tr·∫°ng th√°i ƒë·ªÉ cho ph√©p hi·ªÉn th·ªã l·∫ßn sau
                    } else {  */
                        // N·∫øu h·ª£p l·ªá, hi·ªÉn th·ªã confirm ƒë·ªÉ duy·ªát b√†i
                        iziToast.show({
                            class: "iziToast-custom",
                            title: "X√°c nh·∫≠n duy·ªát",
                            message: "B·∫°n c√≥ ch·∫Øc mu·ªën duy·ªát b√†i ƒëƒÉng n√†y?",
                            position: "center",
                            timeout: false,
                            close: false,
                            overlay: true,
                            icon: "fa fa-question-circle",
                            displayMode: "once",
                            onClosing: function() { // Khi iziToast b·ªã ƒë√≥ng, ƒë·∫∑t l·∫°i bi·∫øn
                                isToastVisible = false;
                            },
                            buttons: [
                                [
                                    '<button><i class="fa fa-check"></i> Duy·ªát</button>',
                                    function (instance, toast) {
                                        isToastVisible = false; // ƒê·∫∑t l·∫°i tr·∫°ng th√°i ƒë·ªÉ cho ph√©p hi·ªÉn th·ªã l·∫ßn sau
                                        instance.hide({ transitionOut: "fadeOut" }, toast, "button");

                                        $.post("@Url.Action("ApprovePost", "Admin")", { id: id }, function (response) {
                                            iziToast.show({
                                                title: response.success ? "Th√†nh c√¥ng!" : "L·ªói!",
                                                message: response.message,
                                                position: "topRight",
                                                color: response.success ? "green" : "red",
                                                timeout: 1000
                                            });

                                            if (response.success) {
                                                updateStatus(id, "ƒê√£ duy·ªát", "bg-success");
                                                toggleButtons(id, "reject");
                                            }
                                        }).fail(() => {
                                            iziToast.error({
                                                title: "L·ªói!",
                                                message: "ƒê√£ x·∫£y ra l·ªói khi duy·ªát b√†i ƒëƒÉng.",
                                                position: "topRight"
                                            });
                                        });
                                    },
                                    true
                                ],
                                [
                                    '<button><i class="fa fa-times"></i> H·ªßy</button>',
                                    function (instance, toast) {
                                        isToastVisible = false; // ƒê·∫∑t l·∫°i tr·∫°ng th√°i ƒë·ªÉ cho ph√©p hi·ªÉn th·ªã l·∫ßn sau
                                        instance.hide({ transitionOut: "fadeOut" }, toast, "button");
                                    }
                                ]
                            ]
                        });
                    /* }
                }).fail(() => {
                    iziToast.error({
                        title: "L·ªói!",
                        message: "ƒê√£ x·∫£y ra l·ªói khi ki·ªÉm tra b√†i ƒëƒÉng.",
                        position: "topRight"
                    });
                    isToastVisible = false; // ƒê·∫∑t l·∫°i tr·∫°ng th√°i ƒë·ªÉ cho ph√©p hi·ªÉn th·ªã l·∫ßn sau
                }); */
            });

            $(document).off("click", ".reject-house").on("click", ".reject-house", function () {
                if (isToastVisible) return; // N·∫øu ƒëang hi·ªÉn th·ªã th√¨ kh√¥ng m·ªü th√™m
                isToastVisible = true;

                const id = $(this).data("id");

                iziToast.show({
                    class: "iziToast-custom",
                    title: 'X√°c nh·∫≠n t·ª´ ch·ªëi',
                    message: 'Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi b√†i ƒëƒÉng:',
                    position: 'center',
                    timeout: false,
                    close: false,
                    overlay: true,
                    icon: 'fa fa-question-circle',
                    drag: false,
                    displayMode: 1,
                    inputs: [
                        [
                            '<textarea id="reject-reason" rows="3" placeholder="Nh·∫≠p l√Ω do..." style="width:100%;resize:none;" required></textarea>',
                            'keyup',
                            function (instance, toast, input, e) {
                                // K√≠ch ho·∫°t input
                            }
                        ]
                    ],
                    onOpening: function(instance, toast){
                        setTimeout(() => {
                            const textarea = toast.querySelector('#reject-reason');
                            if (textarea) textarea.focus();
                        }, 100); // Delay m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o toast ƒë√£ render xong
                    },
                    onClosed: function () {
                        isToastVisible = false; 
                    },
                    buttons: [
                        [
                            '<button><i class="fa fa-times"></i> T·ª´ ch·ªëi</button>',
                            function (instance, toast, button, e, inputs) {
                                const reason = inputs[0].value.trim();

                                if (!reason) {
                                    iziToast.warning({
                                        title: "C·∫£nh b√°o",
                                        message: "Vui l√≤ng nh·∫≠p l√Ω do.",
                                        position: "topRight"
                                    });
                                    return;
                                }

                                instance.hide({ transitionOut: "fadeOut" }, toast, "button");

                                $.post("@Url.Action("RejectPost", "Admin")", { id: id, reason: reason }, function (response) {
                                    iziToast.show({
                                        title: response.success ? "Th√†nh c√¥ng!" : "L·ªói!",
                                        message: response.message,
                                        position: "topRight",
                                        color: response.success ? "green" : "red",
                                        timeout: 1000
                                    });

                                    if (response.success) {
                                        updateStatus(id, "B·ªã t·ª´ ch·ªëi", "bg-danger");
                                        toggleButtons(id, "approve");
                                    }
                                }).fail(() => {
                                    iziToast.error({
                                        title: "L·ªói!",
                                        message: "ƒê√£ x·∫£y ra l·ªói khi t·ª´ ch·ªëi b√†i ƒëƒÉng.",
                                        position: "topRight"
                                    });
                                });
                            },
                            true
                        ],
                        [
                            '<button><i class="fa fa-times"></i> H·ªßy</button>',
                            function (instance, toast) {
                                instance.hide({ transitionOut: "fadeOut" }, toast, "button");
                            }
                        ]
                    ]
                });
            });

            // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i tr√™n giao di·ªán
            function updateStatus(id, statusText, statusClass) {
                const statusCell = $(`tr:has(button[data-id='${id}']) td:nth-child(6)`);
                statusCell.html(`<span class="badge ${statusClass}">${statusText}</span>`);
            }
            
            function toggleButtons(id, action) {
                const row = $(`tr:has(button[data-id='${id}'])`);
                const actionCell = row.find("td:last-child .action-buttons");

                if (action === "reject") {
                    // ƒê√£ duy·ªát ‚Üí Chuy·ªÉn sang ch·ªâ c√≤n n√∫t t·ª´ ch·ªëi
                    row.find(".approve-house").remove();

                    // N·∫øu ch∆∞a c√≥ n√∫t t·ª´ ch·ªëi th√¨ th√™m v√†o
                    if (actionCell.find(".reject-house").length === 0) {
                        actionCell.append(`
                            <button class="btn btn-sm btn-danger reject-house" data-id="${id}">
                                <i class="fas fa-times"></i> T·ª´ ch·ªëi
                            </button>
                        `);
                    }
                } else if (action === "approve") {
                    // B·ªã t·ª´ ch·ªëi ‚Üí Chuy·ªÉn sang ch·ªâ c√≤n n√∫t duy·ªát
                    row.find(".reject-house").remove();

                    // N·∫øu ch∆∞a c√≥ n√∫t duy·ªát th√¨ th√™m v√†o
                    if (actionCell.find(".approve-house").length === 0) {
                        actionCell.append(`
                            <button class="btn btn-sm btn-success approve-house" data-id="${id}">
                                <i class="fas fa-check"></i> Duy·ªát
                            </button>
                        `);
                    }
                }
            }

            // T√¨m ki·∫øm b√†i ƒëƒÉng
            $("#searchInput").on("keyup", function () {
                const value = $(this).val().toLowerCase();
                $("table tbody tr").filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });
            });
        });
    </script>
</body>
