@model IEnumerable<KLTN.Models.HouseType>

<link rel="stylesheet" href="~/css/iziToast.css">

<div class="container">
    <h3 class="text-center mt-3">Qu·∫£n l√Ω Lo·∫°i Nh√†</h3>
    <button class="btn btn-primary mb-2" onclick="openCreateModal()">
        <i class="fa fa-plus-circle"></i> Th√™m m·ªõi
    </button>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th>ID</th>
                <th>T√™n Lo·∫°i Nh√†</th>
                <th>H√†nh ƒê·ªông</th>
            </tr>
        </thead>
        <tbody id="houseTypeTableBody">
            @{
                int index = 1;
            }
            @foreach (var houseType in Model)
            {
                <tr id="row_@houseType.IdHouseType">
                    <td>@index</td>
                    <td>@houseType.Name</td>
                    <td>
                        <button class="btn btn-warning btn-sm"
                            onclick="openEditModal(@houseType.IdHouseType, '@houseType.Name')" title="Ch·ªânh s·ª≠a lo·∫°i nh√†"><i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteHouseType(@houseType.IdHouseType)" title="Xo√° lo·∫°i nh√†"><i
                                class="fas fa-trash-alt"></i> </button>
                    </td>
                </tr>
                index++;
            }
        </tbody>
    </table>
</div>

<!-- Modal ƒë·ªÉ th√™m/s·ª≠a lo·∫°i nh√† -->
<div id="houseTypeModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="modalTitle">Th√™m Lo·∫°i Nh√†</h5>
                <button type="button" class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="houseTypeId">
                <label>T√™n lo·∫°i nh√†:</label>
                <input type="text" id="houseTypeName" class="form-control">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="saveHouseType()">L∆∞u</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">H·ªßy</button>
            </div>
        </div>
    </div>
</div>

<!-- Th√™m th∆∞ vi·ªán iziToast -->
<script src="https://cdn.jsdelivr.net/npm/izitoast/dist/js/iziToast.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast/dist/css/iziToast.min.css">

<script>
    function openCreateModal() {
        $("#modalTitle").text("Th√™m Lo·∫°i Nh√†");
        $("#houseTypeId").val('');
        $("#houseTypeName").val('');
        $("#houseTypeModal").modal("show");
    }

    function openEditModal(id, name) {
        $("#modalTitle").text("S·ª≠a Lo·∫°i Nh√†");
        $("#houseTypeId").val(id);
        $("#houseTypeName").val(name);
        $("#houseTypeModal").modal("show");
    }

    function closeModal() {
        $("#houseTypeModal").modal("hide");
    }

    function saveHouseType() {
        let id = $("#houseTypeId").val();
        let name = $("#houseTypeName").val().trim();

        if (!name) {
            iziToast.warning({
                title: "L·ªói!",
                message: "T√™n lo·∫°i nh√† kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.",
                position: "topRight"
            });
            return;
        }

        let url = id ? "/Admin/EditHouseType" : "/Admin/CreateHouseType";
        let data = JSON.stringify({ IdHouseType: id ? parseInt(id) : 0, Name: name });

        $.ajax({
            type: "POST",
            url: url,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: data,
            success: function (response) {
                iziToast.show({
                    title: response.success ? "‚úÖ Th√†nh c√¥ng!" : "‚ùå L·ªói!",
                    message: response.message,
                    position: "topRight",
                    color: response.success ? "green" : "red",
                    timeout: 1000
                });

                if (response.success) {
                    closeModal();
                    updateHouseTypeTable();
                }
            },
            error: function () {
                iziToast.error({
                    title: "L·ªói!",
                    message: "C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.",
                    position: "topRight"
                });
            }
        });
    }

    function deleteHouseType(id) {
        iziToast.show({
            class: "iziToast-custom",
            title: "üîî X√°c nh·∫≠n x√≥a",
            message: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!",
            position: "center",
            timeout: false,
            close: false,
            overlay: true,
            displayMode: "once",
            drag: false,
            icon: "fa fa-question-circle",
            buttons: [
                [
                    '<button><i class="fa fa-check"></i> C√≥, x√≥a</button>',
                    function (instance, toast) {
                        instance.hide({ transitionOut: "fadeOut" }, toast, "button");

                        $.ajax({
                            type: "POST",
                            url: "/Admin/DeleteHouseType",
                            data: { id: id },
                            success: function (response) {
                                iziToast.show({
                                    title: response.success ? "‚úÖ ƒê√£ x√≥a!" : "‚ùå L·ªói!",
                                    message: response.message,
                                    position: "topRight",
                                    color: response.success ? "green" : "red",
                                    timeout: 1000
                                });

                                if (response.success) {
                                    $("#row_" + id).remove();
                                    updateHouseTypeTable();
                                }
                            }
                        });
                    },
                    true
                ],
                [
                    '<button><i class="fa fa-times"></i> H·ªßy</button>',
                    function (instance, toast) {
                        instance.hide({ transitionOut: "fadeOut" }, toast, "button");
                    }
                ]
            ]
        });
    }

    function updateHouseTypeTable() {
        $.get("/Admin/ManageHouseType", function (data) {
            let newTableBody = $(data).find("#houseTypeTableBody").html();
            $("#houseTypeTableBody").html(newTableBody);
            // C·∫≠p nh·∫≠t l·∫°i ID ƒë·ªÉ ƒë·∫£m b·∫£o n√≥ tƒÉng t·ª´ 1
            let rows = $("#houseTypeTableBody tr");
            rows.each(function (index) {
                $(this).find("td:first").text(index + 1);
            });
        });
    }
</script>
