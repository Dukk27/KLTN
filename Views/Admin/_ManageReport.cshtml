@model IEnumerable<KLTN.Models.Report>

<head>
    <link rel="stylesheet" href="~/css/iziToast.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast/dist/css/iziToast.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/izitoast/dist/js/iziToast.min.js"></script>

    <style>
        th, td {
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            word-wrap: break-word; /* Đảm bảo chữ không bị tràn ra ngoài */
        }

        td:last-child {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .house-link {
            text-decoration: none;
            color: #007bff; /* Thay đổi màu sắc của liên kết */
            font-weight: bold; /* Đậm văn bản */
        }

        .house-link:hover {
            color: #0056b3; /* Thay đổi màu khi hover */
        }

        #content {
            background-color: #fff;
            padding: 30px;
            flex: 1;
            overflow: auto;
            min-height: 100vh;
            position: relative;  /* Thêm position relative cho vùng chứa */
        }

        #pagination {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            padding: 10px 0;
            text-align: center;
            z-index: 100;
        }
    </style>
</head>

<body>
    <h3 class="text-center mt-3">Danh sách báo cáo bài đăng</h3>

    <div class="row mb-3 mt-3">
        <div class="col-12 col-md-4">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm báo xấu...">
            </div>
        </div>
        <div class="col-6 col-md-2 mb-2">
            <input type="date" id="dateFilter" class="form-control">
        </div>
        <div class="col-6 col-md-3 mb-2">
            <select id="reporterFilter" class="form-control">
                <option value="">-- Lọc theo người báo cáo --</option>
                @foreach (var reporter in Model.Select(r => r.User?.UserName).Distinct())
                {
                    <option value="@reporter">@reporter</option>
                }
            </select>
        </div>
        <div class="col-6 col-md-3 mb-2">
            <select id="statusFilter" class="form-control">
                <option value="">-- Lọc theo trạng thái --</option>
                <option value="approved">Đã duyệt</option>
                <option value="pending">Chưa duyệt</option>
            </select>
        </div>
    </div>

    <table class="table table-bordered table-hover">
        <thead>
            <tr>
                <th>ID</th>
                <th>Tiêu đề bài đăng</th>
                <th>Người báo cáo</th>
                <th>Lý do</th>
                <th>Thời gian báo cáo</th>
                <th>Trạng thái</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr id="row-@item.Id">
                    <td>@item.Id</td>
                    <td>
                        <a href="@Url.Action("Detail", "Home", new { id = item.HouseId })" class="house-link">
                            @item.House?.NameHouse
                        </a>
                    </td>
                    <td>@item.User?.UserName</td>
                    <td>@item.Reason</td>
                    <td>@item.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                    <td class="status">
                        @if (item.IsApproved)
                        {
                            <span class="badge bg-success">Đã duyệt</span>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark">Chưa duyệt</span>
                        }
                    </td>
                    <td>
                        @if (!item.IsApproved)
                        {
                            <button class="btn btn-sm btn-success approve-btn" data-id="@item.Id">
                                <i class="fas fa-check"></i> Duyệt
                            </button>
                            <button class="btn btn-sm btn-danger reject-btn" data-id="@item.Id">
                                <i class="fas fa-times"></i> Từ chối
                            </button>
                        }
                        else
                        {
                            <em>Không khả dụng</em>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mt-3" id="pagination"></ul>
    </nav>

    <script> 
        $(document).ready(function () {
            $('.approve-btn').click(function () {
                const id = $(this).data('id');

                $.post('@Url.Action("DuyetBaoCao", "Admin")', { id: id }, function (res) {
                    if (res.success) {
                        iziToast.success({ title: 'Thành công', message: 'Báo cáo đã được duyệt.', position: 'topRight' });

                        const row = $(`#row-${id}`);
                        row.find('.status').html('<span class="badge bg-success">Đã duyệt</span>');
                        row.find('td:last-child').html('<em>Không khả dụng</em>');
                    } else {
                        iziToast.error({ title: 'Lỗi', message: res.message, position: 'topRight' });
                    }
                }).fail(() => {
                    iziToast.error({ title: 'Lỗi', message: 'Không thể kết nối đến máy chủ.', position: 'topRight' });
                });
            });

            $('.reject-btn').click(function () {
                const id = $(this).data('id');

                $.post('@Url.Action("TuChoiBaoCao", "Admin")', { id: id }, function (res) {
                    if (res.success) {
                        iziToast.success({ title: 'Thành công', message: 'Đã từ chối và xóa báo cáo.', position: 'topRight' });

                        $(`#row-${id}`).fadeOut(300, function () { $(this).remove(); });
                    } else {
                        iziToast.error({ title: 'Lỗi', message: res.message, position: 'topRight' });
                    }
                }).fail(() => {
                    iziToast.error({ title: 'Lỗi', message: 'Không thể kết nối đến máy chủ.', position: 'topRight' });
                });
            });

            // Tìm kiếm 
            $("#searchInput").on("keyup", function () {
                const value = $(this).val().toLowerCase();
                $("table tbody tr").filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });
            });

            // Lọc theo người báo cáo
            $("#reporterFilter").on("change", function () {
                filterReports(
                    $("#searchInput").val(),
                    $("#dateFilter").val(),
                    $(this).val(),
                    $("#statusFilter").val()
                );
            });

            // Lọc theo ngày
            $("#dateFilter").on("change", function () {
                filterReports(
                    $("#searchInput").val(),
                    $(this).val(),
                    $("#reporterFilter").val(),
                    $("#statusFilter").val()
                );
            });

            // Lọc theo trạng thái
            $("#statusFilter").on("change", function () {
                filterReports(
                    $("#searchInput").val(),
                    $("#dateFilter").val(),
                    $("#reporterFilter").val(),
                    $(this).val()
                );
            });

            function filterReports(searchText, selectedDate, selectedReporter, selectedStatus) {
                $("table tbody tr").each(function () {
                    const reportText = $(this).text().toLowerCase();
                    const reportDate = $(this).find("td:eq(4)").text().trim(); // cột ngày
                    const reporterName = $(this).find("td:eq(2)").text().trim(); // cột người báo cáo
                    const statusText = $(this).find("td:eq(5)").text().trim(); // cột trạng thái

                    const formattedReportDate = formatDateForComparison(reportDate); // từ dd/MM/yyyy → yyyy-MM-dd

                    const matchesSearch = searchText === "" || reportText.indexOf(searchText.toLowerCase()) > -1;
                    const matchesDate = selectedDate === "" || formattedReportDate === selectedDate;
                    const matchesReporter = selectedReporter === "" || reporterName.trim().toLowerCase() === selectedReporter.trim().toLowerCase();
                    const matchesStatus =
                        selectedStatus === "" ||
                        (selectedStatus === "approved" && statusText.includes("Đã duyệt")) ||
                        (selectedStatus === "pending" && statusText.includes("Chưa duyệt"));

                    if (matchesSearch && matchesDate && matchesReporter && matchesStatus) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });

                reapplyPagination();
            }

            // Hàm áp dụng phân trang
            function reapplyPagination() {
                paginateTable(10); // Số dòng mỗi trang
            }

            // Hàm phân trang
            function paginateTable(rowsPerPage) {
                const rows = $("table tbody tr:visible");
                const totalRows = rows.length;
                const totalPages = Math.ceil(totalRows / rowsPerPage);

                $("#pagination").empty();

                for (let i = 1; i <= totalPages; i++) {
                    $("#pagination").append(`
                        <li class="page-item${i === 1 ? " active" : ""}">
                            <a class="page-link" href="#">${i}</a>
                        </li>
                    `);
                }

                rows.hide();
                rows.slice(0, rowsPerPage).show();

                $("#pagination .page-link").on("click", function (e) {
                    e.preventDefault();
                    const page = parseInt($(this).text());

                    $("#pagination .page-item").removeClass("active");
                    $(this).parent().addClass("active");

                    const start = (page - 1) * rowsPerPage;
                    const end = start + rowsPerPage;

                    rows.hide().slice(start, end).show();
                });
            }

            // Hàm chuyển đổi ngày từ định dạng dd/MM/yyyy sang yyyy-MM-dd
            function formatDateForComparison(reportDate) {
                const parts = reportDate.split(" ")[0].split("/"); // Lấy ngày (dd/MM/yyyy)
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];
                return `${year}-${month}-${day}`;
            }

            reapplyPagination();
        });
    </script>
</body>